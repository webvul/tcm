 /*! tcm 2016-05-03 */
!function(){IX.ns("TCM.Const"),TCM.Const.SiteTypes={TCC:0,OCC:1,Depot:2,Station:3,BOCC:4,LinePolice:5,PTSD:6},TCM.Const.SiteTypeNames=["指挥中心","控制中心","车辆段／停车场","车站","备用控制中心","公安派出所","公交总队"],TCM.Const.UserTypes={Super:0,Admin:1,User:2},TCM.Const.UserTypeNames=["超级用户","管理员","普通用户"],TCM.Const.DeviceTypes={TNM:0,TVS:1,TAS:2,TVR:3,Storage:10,IPCFixed:20,IPCSemiSphere:21,IPCSphere:22,CameraFixed:31,CameraSemiSphere:32,CameraSphere:33,RedirectPickup:40,OmnidirectPickup:41,Coder:50,Decoder:51,Spliter:52,Monitor:53,Terminal:54,SpecialDecoder:55,HUB:60,PDH:61,FiberConvertor:62,KVM:63,PDU:64,VDM:65,Other:90},TCM.Const.DeviceTypeNames={0:"网管服务器",1:"视频服务器",2:"视频分析服务器",3:"存储服务器",10:"存储设备",20:"固定枪机",21:"半球机",22:"球机",31:"固定枪机",32:"半球机",33:"球机",40:"定向拾音器",41:"全向拾音器",50:"编码器",51:"解码器",52:"画面分割器",53:"监视器",54:"控制终端",55:"解码器",60:"交换机",61:"光端机",62:"光纤收发器",63:"数字KVM",64:"数字PDU",65:"字符叠加器",90:"其他设备"},TCM.Const.DriverList=[{name:"DahuaMulticastHost",provider:"大华",style:"通用",username:"admin",password:"admin",port:"37777"},{name:"rtsphost",provider:"东方网力测试",style:"RTSP",username:"admin",password:"admin",port:"554"},{name:"multitesthost",provider:"东方网力测试",style:"组播",username:"admin",password:"admin",port:"3077"},{name:"netposamultidechost",provider:"东方网力",style:"890",username:"admin",password:"admin",port:"4601"}],TCM.Const.Days="周日,周一,周二,周三,周四,周五,周六".split(",")}(),function(){function a(a,b){function c(a,b){return null===a||null===b||a.id==b.id}function d(a,b){b in j||(j[b]={});var c=j[b],d=a[b];d in c||(c[d]=[]),c[d].push(a.id)}function e(a,c){h[a.id]=c,i[a.name]=c,IX.iterate(b,function(b){d(a,b)})}function f(){g=IX.Array.toSet(g,c),h={},i={},j={},IX.iterate(g,e)}var g=[].concat(a),h={},i={},j={};return f(),{getAll:function(){return g},get:function(a){return g[h[a]]},getByName:function(a){return g[i[a]]},getBy:function(a,b){return IX.map(j[a][b],function(a){return g[a]})},add:function(a){g.push(a),f()},update:function(a){var b=h[a.id];null!==b&&void 0!==b?g[b]=a:g.push(a),f()},remove:function(a){g[a.id]=null,f()},refresh:function(a){g=[].concat(a),f()}}}function b(a){c=$XP(a,"name",""),d.refresh($XP(a,"sites",[])),e.refresh($XP(a,"roles",[])),f.refresh($XP(a,"levels",[]))}var c="",d=new a([],["type"]),e=new a([],["siteType"]),f=new a([],["level"]),g=TCM.Const.SiteTypeNames;IX.ns("TCM.LineInfo"),TCM.LineInfo.init=function(a){b(a)},TCM.LineInfo.refresh=function(a){b(a)},TCM.LineInfo.destroy=function(){c="",d.refresh([]),e.refresh([]),f.refresh([])},TCM.LineInfo.getName=function(){return c},TCM.LineInfo.setName=function(a){c=a},TCM.LineInfo.getSites=function(){return d},TCM.LineInfo.getSiteName=function(a){var b=d.get(a);return b?b.name:""},TCM.LineInfo.getRoles=function(){return e},TCM.LineInfo.getRoleName=function(a){var b=e.get(a);return b?b.name:""},TCM.LineInfo.getSiteTypeNameOfRole=function(a){var b=e.get(a);return b&&null!==b.siteType?g[b.siteType]:""},TCM.LineInfo.getLevels=function(){return f},IX.ns("TCM.DeviceType"),TCM.DeviceType.getNodeName=function(a){switch(a){case TCM.Const.DeviceTypes.TNM:case TCM.Const.DeviceTypes.TVS:case TCM.Const.DeviceTypes.TAS:case TCM.Const.DeviceTypes.TVR:return"server";case TCM.Const.DeviceTypes.Storage:return"storage";case TCM.Const.DeviceTypes.IPCFixed:case TCM.Const.DeviceTypes.IPCSemiSphere:case TCM.Const.DeviceTypes.IPCSphere:return"IPC";case TCM.Const.DeviceTypes.CameraFixed:case TCM.Const.DeviceTypes.CameraSemiSphere:case TCM.Const.DeviceTypes.CameraSphere:return"camera";case TCM.Const.DeviceTypes.RedirectPickup:case TCM.Const.DeviceTypes.OmnidirectPickup:return"pickup";case TCM.Const.DeviceTypes.Coder:return"coder";case TCM.Const.DeviceTypes.Decoder:return"decoder";case TCM.Const.DeviceTypes.SpecialDecoder:return"specialDecoder";case TCM.Const.DeviceTypes.Spliter:return"spliter";case TCM.Const.DeviceTypes.Monitor:return"monitor";case TCM.Const.DeviceTypes.Terminal:return"terminal";case TCM.Const.DeviceTypes.VDM:return"vdm";case TCM.Const.DeviceTypes.HUB:case TCM.Const.DeviceTypes.PDH:case TCM.Const.DeviceTypes.FiberConvertor:case TCM.Const.DeviceTypes.KVM:case TCM.Const.DeviceTypes.PDU:case TCM.Const.DeviceTypes.Other:return"other"}}}(),function(){IX.ns("TCM.Util");var a=5e3;TCM.Util.PeriodicChecker=function(b,c,d){function e(){return IX.isFn(b)&&!b()?void(f=!1):(h=function(){return setTimeout(function(){f&&e()},g)},void c(f,h))}var f=!1,g=d||a,h=null;return{start:function(){f||e(),f=!0},stop:function(){f=!1,clearTimeout(h)}}}}(),function(){function a(a){var b=$XP(a,"name"),c=$XP(a,"title",b);$XP(a,"isLongStr");return{getTitleTpldata:function(){return{html:IX.encodeTXT(c),name:b,sortClz:"up"}},getCellTpldata:function(a){return{name:b,html:IX.encodeTXT($XP(a,b,"")),title:IX.encodeTXT($XP(a,b,"")),longClz:"longName"}}}}function b(a,b,c,d){function e(){return IX.map(b,function(b){return b.getCellTpldata(a)})}function f(){return IX.loop(c,[],function(a,b){return a.push({name:b[0],title:b[1],html:""}),a})}function g(){return IX.map(d,function(a){return{name:a[0],html:a[1]}})}var h=a.id,i={id:h,clz:"",moreClz:0===d.length?"hidden":"",dropdowcActs:g(),cells:e(),actions:f()};return{getId:function(){return h},get:function(b){return $XP(a,b)},refresh:function(b){a=b,i.cells=e()},getTpldata:function(){return i}}}var c={};IX.ns("IXW.Lib"),IXW.Lib.GridModel=function(a,d){function e(a,b){n.load(a,g,function(a){m.rows=IX.map(a,function(a){return a.getTpldata()}),b(a)})}var f=$XP(d,"clz",""),g=$XP(d,"pageSize",20),h=$XP(d,"rowModel",b),i=$XF(d,"dataLoader"),j=IX.map($XP(d,"columns",[]),function(a){return a in c?new c[a]:null}),k=$XP(d,"actions",[]),l=$XP(d,"moreActions",[]),m={clz:f,id:a,header:IX.map(j,function(a){return a.getTitleTpldata()}),rows:[]},n=new IX.IPagedManager(function(a){return new h(a,j,k,l)},null,i);return{getDataModel:function(){return n},getRow:n.get,getFirst:n.getFirst,addItems:n.addItems,removeItems:n.removeItems,getTotal:function(){return n.getTotal()},getTpldata:function(){return m},getPageCount:function(){return Math.ceil(n.getTotal()/g)},resetPage:function(a,b,c){g=b,e(a,c)},load:function(a,b){e(a,b)}}},IXW.Lib.GridModel.RowModelBase=b,IXW.Lib.GridModel.ColumnModelBase=a,IXW.Lib.GridModel.registerColumnModel=function(a,b){c[a]=b}}(),function(){function a(){g&&g.hide()}function b(a){a.className="ixw-body nv-dialog "+$XP(h,"clz",""),a.innerHTML=j.renderData("",{title:$XP(h,"title",""),content:$XP(h,"content",""),lbtns:$XP(h,"btns.left",m.left),rbtns:$XP(h,"btns.right",m.right)}),$XF(h,"afterShow")(a)}function c(a){h=a,0===jQuery(".confirmLogin").length&&(g||(g=new IXW.Lib.ModalDialog({id:"nv-dialog",bodyRefresh:b})),g.show())}function d(a){var b=IXW.Lib.alert(a);$XH.addClass($XH.first(b,"ixw-alert"),"animate-shake")}function e(a){i=a;var b=IXW.Lib.alert(i.content);jQuery(".ixw-close").remove(),jQuery($XH.first(b,"ixw-alert")).addClass("ixw-confirm").append(jQuery(l.renderData("",{}))),$XH.addClass($XH.first(b,"ixw-alert"),"animate-shake")}var f=IXW.Actions.configActions,g=null,h=null,i=null,j=new IX.ITemplate({tpl:['<div class="head">{title}</div>','<div class="content">{content}</div>','<div class="foot">','<div class="l btns">','<tpl id="lbtns">','<a class="btn {name}btn" data-href="$nvdialog-click" data-key="{name}">{text}</a>',"</tpl>","</div>",'<div class="r btns">','<tpl id="rbtns">','<a class="btn {name}btn" data-href="$nvdialog-click" data-key="{name}">{text}</a>',"</tpl>","</div>","</div>	",""]}),k=new IX.ITemplate({tpl:['<div class="area confirm"><div class="msg">{msg}</div></div>',""]}),l=(new IX.ITemplate({tpl:['<div id="nv-alert">','<div class="nv-alert animate-shake">','<div class="nv-bg alert"></div>','<span class="nv-close"><a data-href="$colse-alert">&times;</a></span>','<span class="alert-content">{content}</span>',"</div>","</div>",""]}),new IX.ITemplate({tpl:['<div class="confirm-btn">','<a data-href="$confirm.ok" class="firm firm-ok">确定</a>','<a data-href="$confirm.no" class="firm firm-no">取消</a>',"</div>",""]})),m={left:[],right:[{name:"ok",text:"确定"},{name:"cancel",text:"取消"}]};f([["nvdialog-click",function(b,c){var d=b.key;return"cancel"===d?a():void $XF(h,"listen."+d)()}],["ixw.alert.close",function(a,b){jQuery($XH.ancestor(b,"ixw-alert")).removeClass("animate-shake"),jQuery("#IXW-alert").fadeOut();
}],["confirm.ok",function(a,b){jQuery("#IXW-alert").fadeOut(),i.okFn()}],["confirm.no",function(a,b){jQuery("#IXW-alert").fadeOut()}]]),IX.ns("NV.Dialog"),NV.Dialog.show=c,NV.Dialog.hide=a,NV.Dialog.confirm=function(b,d,e){c({title:IX.encodeTXT(b),content:k.renderData("",{msg:d}),listen:{ok:function(){e(a)}}})},NV.Dialog.confirm4login=function(b,d,e,f){c({title:IX.encodeTXT(b),clz:"confirmLogin",btns:e,content:k.renderData("",{msg:d}),listen:{ok:function(){f(a)}}})},NV.Dialog.alert=d,IX.ns("NV.Lib"),NV.Lib.confirm=e}(),function(){function a(a,b,c){return f.renderData("",IX.inherit({valueId:a,comboId:a+"_combo"},b)).replaceAll("{action}",c?c:"nvcombo.pick")}function b(a,b){return g.renderData("",IX.inherit({valueId:a,comboId:a+"_radioCombo"},b)).replaceAll("{action}","nvradiocombo.pick")}function c(a,b,c,d){return h.renderData("",{valueId:a,value:b,text:c,clz:b?"selected":""}).replaceAll("{action}",d?d:"nvcheckbox.check")}var d=IXW.Actions.configActions,e=new IX.ITemplate({tpl:['<div class="leaf {clz}">','<a class="nv-checkbox {chkClz}" data-href="${action}" data-key="{key}">','<span class="ixpic-"></span><span class="text">{name}</span></a>',"</div>",""]}),f=new IX.ITemplate({tpl:['<span class="dropdown">','<input type="hidden" id="{valueId}" value="{value}">','<button class="dropdown-toggle" type="button" id="{comboId}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">','<span class="name">{valueText}</span><span class="pic-"></span>',"</button>",'<ul class="dropdown-menu" aria-labelledby="{comboId}">','<tpl id="items">','<li class="{clz}">','<a data-href="${action}" data-key="{id}">{name}</a>',"</li>","</tpl>","</ul>","</span>",""]}),g=new IX.ITemplate({tpl:['<span class="dropdown">','<input type="hidden" id="{valueId}" value="{value}">','<button class="dropdown-toggle" type="button" id="{comboId}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">','<span class="name">{valueText}</span><span class="pic-"></span>',"</button>",'<div class="dropdown-menu {dropdownClz}" aria-labelledby="{comboId}">','<tpl id="items">',e.renderData("",{clz:"item",key:"{id}",action:"{action}"}),"</tpl>","</div>","</span>",""]}),h=new IX.ITemplate({tpl:['<input type="hidden" id="{valueId}" value="{value}">','<a class="nv-checkbox {clz}" data-href="${action}">','<span class="ixpic-"></span><span>{text}</span></a>',""]});d([["nvcombo.pick",function(a,b){var c=a.key,d=b.innerHTML,e=$XH.ancestor(b,"dropdown");if(e){var f=$XD.first(e,"input");f.value=c;var g=$XH.first($XH.first(e,"dropdown-toggle"),"name");g.innerHTML=d}}],["nvcheckbox.check",function(a,b){var c=!$XH.hasClass(b,"selected");$XH[c?"addClass":"removeClass"](b,"selected");var d=$XD.first(b.parentNode,"input");d.value=c}],["nvradiocombo.pick",function(a,b){var c=jQuery(".dropdown-menu").children(".leaf");c.each(function(){jQuery(this).children(".nv-checkbox").removeClass("selected")}),$XH.toggleClass(b,"selected");var d=a.key,e=jQuery(b).children(".text").html(),f=$XH.ancestor(b,"dropdown");if(f){var g=$XD.first(f,"input");g.value=d;var h=$XH.first($XH.first(f,"dropdown-toggle"),"name");h.innerHTML=e}}]]),IX.ns("NV.Lib"),NV.Lib.getComboHTML=a,NV.Lib.getRadioComboHTML=b,NV.Lib.getCheckboxHTML=c,IX.setNS("TCM.Tpl.nvRadio",g)}(),function(){function a(a){var b=$XH.ancestor(a,"ixw-grid");return b?c[b.id]:null}var b=IXW.Actions.configActions,c={};b([["ixw.grid.col",function(b,c){var d=a(c);d&&d.colAction(b.key,c)}],["ixw.grid.cell",function(b,c){var d=a(c),e=$XH.ancestor(c,"row");d&&e&&d.cellAction($XD.dataAttr(e,"id"),b.key,c)}],["ixw.grid.action",function(b,c){var d=a(c),e=$XH.ancestor(c,"row");d&&e&&d.rowAction($XD.dataAttr(e,"id"),b.key,e)}]]);var d=new IX.ITemplate({tpl:['<div id="{id}" class="ixw-grid {clz}">','<ul class="hdr">','<tpl id="header">','<li class="col-{name}">','<a data-href="$ixw.grid.col" data-key="{name}">',"<span>{html}</span>",'<span class="pic- hide"></span>',"</a>","</li>","</tpl>","</ul>",'<div class="body">','<tpl id="rows">','<ul data-id="{id}" class="row {clz}">','<tpl id="cells">','<li class="col-{name}">','<a class="cell {longClz}" data-href="$ixw.grid.cell" data-key="{name}" title = "{title}">{html}</a>',"</li>","</tpl>",'<li class="r col-actions invisible">','<div class="btns-group {moreClz}">','<a class="act-more dropdown-toggle" data-toggle="dropdown" title="更多操作"></a>','<ul class="dropdown-menu">','<tpl id="dropdowcActs">','<li><a data-href="$nvgrid.clickTool" data-key="{name}">{html}</a></li>',"</tpl>","</ul>","</div>",'<tpl id="actions">','<a class="act-{name}" data-href="$ixw.grid.action" data-key="{name}" title="{title}">{html}</a>',"</tpl>","</li>","</ul>","</tpl>","</div>","</div>",""]});IX.ns("IXW.Lib"),IXW.Lib.Grid=function(a){function b(){var a=$X(f);a&&(a.innerHTML=d.renderData("",i.getTpldata()))}function e(a){var b=$XH.first($X(g),"body");if(b&&!a){var c=i.getTpldata();b.innerHTML=IX.map(c.rows,function(a){return d.renderData("rows",a)}).join("")}}var f=$XP(a,"container"),g=a.id||IX.id(),h=IX.loop($XP(a,"actions",[]),{},function(a,b){return a[b[0]]=b[2],a}),i=new IXW.Lib.GridModel(g,a),j={getHTML:function(){return d.renderData("",i.getTpldata())},getId:function(){return g},getModel:function(){return i},show:function(){i.load(0,b)},refresh:function(a){e(a)},colAction:function(a,b){},cellAction:function(a,b,c){},rowAction:function(a,b,c){h[b](i.getRow(a),c)}};return c[g]=j,j}}(),function(){function a(a){return{id:a,indics:[{stx:0,endx:0,pagex:0}],paginHTML:"",pageInfo:g.text,list:IX.map(f,function(a){return{value:a.id,clz:a.id==g.id?"disabled":"",html:a.text}})}}function b(b){var c=new IXW.Lib.Pagination({id:b+"-pagin",total:0,current:0}),d=a(b);return d.paginHTML=c.getHTML(),{getHTML:function(){return e.renderData("",d)},getCurrentPageNo:function(){return c.getCurrentPageNo()},bind:function(a,d){c.bind(a),h[b]=function(a){d(0,a)}},jump:c.jump,refresh:function(a,f,h,i,j){c.apply(f,a,i),d.paginHTML=c.getHTML();var k=0!==j?f*g.value+1:0;d.indics=[{stx:k,endx:Math.max(k+h-1,0),pagex:j}];var l=$X(b+"-indics");!i&&l&&(l.innerHTML=e.renderData("indics",d.indics[0]))}}}function c(a,b){function c(b){var c=jQuery("#"+a+"_tool .chkEnable");c[b?"removeClass":"addClass"]("disabled")}var d={id:a,btns:IX.map($XP(b,"buttons",[]),function(a){return{name:a.name,clz:$XP(a,"chkEnabled",!0)?"chkEnable disabled":""}})};return j[a]=function(a){$XF(b,"actions."+a)()},{getHTML:function(){return i.renderData("",d)},enable:function(){c(!0)},disable:function(){c(!1)}}}var d=IXW.Actions.configActions,e=(IXW.Lib.Grid,new IX.ITemplate({tpl:['<div id="{id}-indics" class="l">','<tpl id="indics">',"从<span>{stx}</span>到<span>{endx}</span>/共<span>{pagex}</span>条数据","</tpl>","</div>",'<div class="m">{paginHTML}</div>','<div class="r">','<span>显示</span><div class="page">','<div class="dropdown">','<a class="changePage dropdown-toggle" data-toggle="dropdown">','<span id="curPage" class="pagesize">{pageInfo}</span><span class="pgFrame"><span class="pic-pg"></span></span>',"</a>",'<ul class="dropdown-menu">','<tpl id="list">','<li class="{clz}" id="{id}">','<a class="pagesize" data-href="$nvpagin.change" data-key="{value}" data-target="{id}">{html}</a>',"</li>","</tpl>","</ul>","</div></div>","</div>",""]})),f=[{id:"page-0",value:20,text:"每页20条"},{id:"page-1",value:50,text:"每页50条"},{id:"page-2",value:100,text:"每页100条"}],g=f[0],h={};d([["nvpagin.change",function(a,b){var c=b.parentNode;if(!$XH.hasClass(c,"disabled")){var d=$XH.ancestor(c,"dropdown"),e=$XH.first($XD.first(d,"a"),"pagesize");e.innerHTML=b.text,$XH.removeClass($XH.first(c.parentNode,"disabled"),"disabled"),$XH.addClass(c,"disabled"),g=f[a.key.split("-").pop()];var i=h[$XD.dataAttr(b,"target")];IX.isFn(i)&&i(g.value)}}]]);var i=new IX.ITemplate({tpl:['<div id="{id}_tool">','<tpl id="btns">','<a class="btn-{name} {clz}" data-href="$nvtool.click" data-target="{id}" data-key="{name}"></a>',"</tpl>","</div>",""]}),j={};d([["nvtool.click",function(a,b){if(!$XH.hasClass(b,"disabled")){var c=j[$XD.dataAttr(b,"target")];IX.isFn(c)&&c(a.key)}}]]);var k=new IX.ITemplate({tpl:['<div id="{id}" class="nv-grid nv-box {gridClz}">','<div class="nvgrid-title nv-title">{title}</div>','<div class="nvgrid-tools">{toolHTML}</div>','<div class="nvgrid-body">{gridHTML}</div>','<div class="nvgrid-foot">{paginHTML}</div>',"</div>",""]
});IX.ns("NV.Lib"),NV.Lib.Grid=function(a){function d(){jQuery($X(l)).find(".row").hover(function(){$XH.addClass(this,"hover")},function(){$XH.removeClass(this,"hover")})}function e(){return jQuery("#"+m+"-grid").find(".row .selected")}function f(a,b,c){q.refresh(c),c||d(),s&&s.refresh(r.getPageCount(),a,b.length,c,r.getTotal()),t&&t.disable()}function h(a){r.load(a,function(b){f(a,b)})}function i(b){var c=$X(l);c&&(f(0,b,!0),c.innerHTML=k.renderData("",{id:m,gridClz:$XP(a,"clz",""),title:$XP(a,"title",""),toolHTML:t?t.getHTML():"",gridHTML:q.getHTML(),paginHTML:s?s.getHTML():""}),d())}function j(a){jQuery(".nvgrid-body .col-_check .checkbox").removeClass("selected"),jQuery(".nvgrid-tools .chkEnable").addClass("disable"),s?s.jump(a):h(0)}var l=$XP(a,"container"),m=a.id||IX.id(),n=$XP(a,"tools"),o=$XP(a,"usePagination",!0),p=$XF(a,"clickOnRow"),q=new IXW.Lib.Grid(IX.inherit(a,{id:m+"-grid",pageSize:g.value,dataLoader:$XF(a,"dataLoader")})),r=q.getModel(),s=null,t=null,u=IX.emptyFn;return n&&(t=new c(m,n),u=function(){var a=e();t[a.length>0?"enable":"disable"]()}),q.colAction=function(a,b){if("_check"==a){var c=jQuery(b),d=c.find(".checkbox").hasClass("selected"),e=c.parents(".ixw-grid").find(".col-_check .checkbox");e[d?"removeClass":"addClass"]("selected"),u()}},q.cellAction=function(a,b,c){if("_check"==b){$XH.toggleClass($XH.first(c,"checkbox"),"selected");var d=!0;jQuery(".ixw-grid .body").find(".checkbox").each(function(){$XH.hasClass(this,"selected")||(d=!1)});var e=jQuery(".ixw-grid").find(".hdr .checkbox")[0];d?$XH.addClass(e,"selected"):$XH.removeClass(e,"selected"),u()}else p(a,b,c)},o&&(s=new b(m),s.bind(h,function(a,b){r.resetPage(a,b,function(b){f(a,b)})})),{getModel:function(){return r},getSelectedRows:function(){return IX.map(e(),function(a){var b=$XH.ancestor(a,"row");return r.getRow($XD.dataAttr(b,"id"))})},addItems:function(a){r.addItems(a),j(r.getPageCount()-1)},removeItems:function(a){r.removeItems(a),j(Math.min(s?s.getCurrentPageNo():0,r.getPageCount()-1))},show:function(){r.load(0,i)},refresh:function(a){j(a)}}}}(),function(){function a(a,b,c,d){var f=new e({name:a,title:b});return f.getCellTpldata=function(b){return{name:a,html:c(b),title:d?c(b):"",longClz:d?"longName":""}},f}function b(a,b){var c=a[b];return l.renderData("",{name:g.getRoleName(c.id)||"预留",type:g.getSiteTypeNameOfRole(c.id),prompt:c.prompted?"允许临时权限提升":""})}function c(a){return{getTitleTpldata:function(){return{name:"role",html:m[a]}},getCellTpldata:function(c){return{name:"role",html:b(c,a),title:"",longClz:""}}}}var d=IXW.Lib.GridModel,e=d.ColumnModelBase,f=d.registerColumnModel,g=TCM.LineInfo,h=TCM.Const.SiteTypeNames,i=TCM.Const.UserTypeNames,j=TCM.Const.DeviceTypeNames,k=new IX.ITemplate({tpl:["<div>{title}</div>","<ul>",'<li class="col-role-name">角色名称</li>','<li class="col-role-type">所属单位类型</li>','<li class="col-role-prompt {clz}">特殊处理</li>',"</ul>"]}),l=new IX.ITemplate({tpl:["<ul>",'<li class="col-role-name">{name}</li>','<li class="col-role-type">{type}</li>','<li class="col-role-prompt">{prompt}</li>',"</ul>"]}),m={station:k.renderData("",{title:"车站优先级说明",clz:"prompt1"}),depot:k.renderData("",{title:"车辆段／停车场优先级说明",clz:"prompt2"})},n={html:"<span class='checkbox'></span>",name:"_check",title:"",longClz:""};IX.iterate([["_checkbox",function(){return{getTitleTpldata:function(){return n},getCellTpldata:function(){return n}}}],["_no","编号"],["name",{name:"name",title:"名称",isLongStr:!0}],["desc",{name:"desc",title:"说明",isLongStr:!0}],["siteNo",{name:"no",title:"编号"}],["siteType",function(){return a("type","单位类型",function(a){return h[a.type]||""},!0)}],["roleName",{name:"name",title:"角色名称",isLongStr:!0}],["roleType",function(){return a("type","角色所属单位类型",function(a){return h[a.siteType]||""},!0)}],["rolePromptable",function(){return a("promptable","特殊情况下是否允许启动临时授权",function(a){return a.promptable?"允许":""})}],["levelName",{name:"name",title:"级别"}],["station",function(){return c("station")}],["depot",function(){return c("depot")}],["userName",{name:"name",title:"用户名"}],["account","登录账号"],["utype",function(){return a("type","用户类型",function(a){return i[a.type]||""},!0)}],["userSite",function(){return a("site","所属单位",function(a){return g.getSiteName(a.siteId)},!0)}],["userRole",function(){return a("role","用户角色",function(a){return g.getRoleName(a.role)},!0)}],["devNo","编号"],["devType",function(){return a("type","设备类型",function(a){return j[a.type]||""},!0)}],["Provider",function(){return a("provider","厂家",function(a){return TCM.Device.getDriver(a.driverId).provider||""},!0)}],["Style",function(){return a("style","型号",function(a){return TCM.Device.getDriver(a.driverId).style||""},!0)}],["devName",function(){return a("name","名称",function(a){return IX.encodeTXT(a.name||"")},!0)}],["devProvider",function(){return a("provider","厂家",function(a){return IX.encodeTXT($XP(a,"provider",""))},!0)}],["devStyle",function(){return a("style","型号",function(a){return IX.encodeTXT($XP(a,"style",""))})}],["devDesc",function(){return a("desc","备注",function(a){return IX.encodeTXT($XP(a,"desc",""))},!0)}],["devIp",function(){return a("ip","IP地址",function(a){return IX.encodeTXT($XP(a,"ip",""))})}],["devManageIp",function(){return a("manageIp","管理口IP地址",function(a){return IX.encodeTXT($XP(a,"manageIp",""))})}],["devPort",function(){return a("port","端口号",function(a){return IX.encodeTXT($XP(a,"port",""))})}],["devChannelNum",function(){return a("channelNum","通道数",function(a){return IX.encodeTXT($XP(a,"channelNum",""))})}],["devVersion",function(){return a("version","软件版本号",function(a){return IX.encodeTXT($XP(a,"version",""))},!0)}],["devbcPort",function(){return a("bcPort","组播流端口",function(a){return IX.encodeTXT($XP(a,"bcPort",""))})}],["devdiskNum",function(){return a("diskNum","硬盘数量",function(a){return IX.encodeTXT($XP(a,"diskNum",""))})}],["devCapacity",function(){return a("capacity","总容量",function(a){return IX.encodeTXT($XP(a,"capacity",""))+"GB"})}],["devPath",function(){return a("path","对应的软件名称或网页地址",function(a){return IX.encodeTXT($XP(a,"path",""))},!0)}],["devRelatedSpliter",function(){return a("relatedSpliter","关联画面分割器",function(a){return IX.encodeTXT($XP(a,"relatedSpliter",""))},!0)}],["devMaxWindow",function(){return a("maxWindow","最大画面数",function(a){return IX.encodeTXT($XP(a,"maxWindow",""))})}],["num","数量"],["zno","编号"],["zname","名称"],["dname","摄像机名称"],["dstat","录像状态"],["startDate","录像开始时间"],["endDate","录像结束时间"],["range",function(){var a=new e({name:"range",title:"完整录像周期显示"});return a.getCellTpldata=function(a){return{name:"range",html:"<span class='range'></span>"}},a}]],function(a){var b=a[0],c=a[1];f(b,IX.isFn(c)?c:function(){return new e(IX.isString(c)?{name:b,title:c}:c)})})}(),function(){function a(a,c,d,e){var f=new b(a,c,d,e),g=f.getTpldata();return g.clz=a.enabled?"":"disabled",f.getTpldata=function(){return g},f}var b=IXW.Lib.GridModel.RowModelBase;IX.ns("TCM.Lib");var c={refresh:!1,create:!1,add:!1,"delete":!0};TCM.Lib.Grid=function(b,d){function e(){i(function(a){h.addItems(a.ids)})}function f(a){j(a,function(){h.removeItems(IX.map(a,function(a){return a.getId()}))})}function g(a){f([a])}var h=null,i=$XF(d,"listen.createItem"),j=$XF(d,"listen.deleteItems");return h=new NV.Lib.Grid(IX.inherit(d.grid,{container:b,title:$XP(d,"title",""),rowModel:$XP(d,"rowModel",a),actions:IX.loop($XP(d,"grid.actions",[]),[],function(a,b){return IX.isString(b)?("delete"==b&&a.push(["delete","删除",g]),a):(b.length<=2&&"delete"==b[0]&&(b[2]=g),a.push(b),a)}),tools:{buttons:IX.map($XP(d,"tools.buttons",[]),function(a){return{name:a,chkEnabled:c[a]}}),actions:IX.inherit({refresh:function(){h.refresh()},create:e,add:e,"delete":function(){f(h.getSelectedRows())}},$XP(d,"tools.actions"))}})),h.show(),h}}(),function(){var a=NV.Lib.getComboHTML;IX.ns("TCM.Lib");var b=TCM.Const.SiteTypeNames,c=IX.map(b,function(a,b){return{id:b,name:a,action:"sys.changeSiteType"}});TCM.Lib.getSiteTypeComboHTML=function(d,e){var f=IX.isEmpty(e)?3:e;return a(d,{value:f,valueText:b[f],items:c})},TCM.Lib.getRoleComboHTML=function(b,c,d){var e=TCM.LineInfo.getRoles(),f=e.get(c),g=f?f.name:"",h=TCM.Env.getSession().getCurrentSiteType(),i=IX.loop(e.getAll(),[],function(a,b){return h==b.siteType&&a.push(b),a});return a(b,{
value:c,valueText:g,items:d?e.getAll():i})}}(),function(){function a(a){var b=$XH.ancestor(a,"nv-tree");return b?e[b.id]:null}var b=new IX.ITemplate({tpl:["<ul>",'<tpl id="items">','<li class="{expandClz}">','<a class="{clz}" data-href="$tree.click" data-key="{key}" data-siteId="{siteId}" data-name="{name}" data-zoneId="{zoneId}">','<span class="pic-expand"></span>',"<span>{html}</span>","</a>{HTML}","</li>","</tpl>","</ul>",""]}),c=new IX.ITemplate({tpl:['<div class="nv-tree" id="{id}">{html}</div>',""]}),d=IXW.Actions.configActions,e={};d([["tree.click",function(b,c,d){if($XH.hasClass(d.target,"pic-expand")){var e=jQuery(c).parent().get(0);"none"==jQuery(c).parent().children("ul").css("display")?(jQuery(c).parent().children("ul").slideDown(),$XH.hasClass(e,"none")||($XH.removeClass(e,"rotation"),jQuery(c).parent().find("ul>li").removeClass("rotation"),$XH.removeClass(e,"expand"),$XH.addClass(e,"fold"))):(jQuery(c).parent().children("ul").slideUp(),$XH.hasClass(e,"none")||($XH.removeClass(e,"fold"),$XH.addClass(e,"expand"),$XH.addClass(e,"rotation")))}else{if("{key}"==b.key)return;jQuery(".nv-tree").find("a").removeClass("select"),jQuery(c).addClass("select"),a(c)({keys:b.key,siteId:$XD.dataAttr(c,"siteId"),name:$XD.dataAttr(c,"name"),zoneId:$XD.dataAttr(c,"zoneId"),el:c})}}]]),IX.ns("TCM.Lib"),TCM.Lib.Tree=function(a){function d(c){return b.renderData("",{items:IX.map(c,function(b){var c=0===b.nodes.length?"":d(b.nodes);return{clz:"tree-node",expandClz:""===c?"none":"expand",html:a.htmlFn(b),key:b.key,siteId:b.siteId,name:b.name,zoneId:b.zoneId,HTML:c}})})}function f(){return c.renderData("",{id:g,html:d(a.nodes)})}var g=($XP(a,"container"),IX.id());e[g]=$XF(a,"click");var h={getHTML:function(){return f()},refresh:function(){}};return h}}(),function(){function a(b){for(var c=b.parent().find(".node .nv-checkbox"),d=0,e=c.length,f=0;e>f;f++)$XH.hasClass(c[f],"selected")&&(d+=1);d==e&&(b.parent().children(".leaf").find(".nv-checkbox").addClass("selected"),b.parent().children(".leaf").find(".nv-checkbox").addClass("part")),d>0&&d!=e&&(b.parent().children(".leaf").find(".nv-checkbox").removeClass("selected"),b.parent().children(".leaf").find(".nv-checkbox").addClass("part")),0===d&&(b.parent().children(".leaf").find(".nv-checkbox").removeClass("selected"),b.parent().children(".leaf").find(".nv-checkbox").removeClass("part")),b.parent().hasClass("node")&&a(b.parent())}function b(a){var b=jQuery(a),c=b.find(".line>.nv-checkbox")[0];if($XH.hasClass(c,"selected"))return"all";var d=b.find(".site");return IX.loop(d,[],function(a,b){var c=$XH.first(b,"nv-checkbox"),d=$XD.dataAttr(c,"key")-0;if($XH.hasClass(c,"selected"))return a.push([d,"all"]),a;var e=jQuery(b.parentNode).find(".item>.selected");if(0===e.length)return a;var f=IX.map(e,function(a){return $XD.dataAttr(a,"key")-0});return a.push([d,f]),a})}function c(a){switch(a){case q.IPCFixed:case q.CameraFixed:return 0;case q.IPCSphere:case q.CameraSphere:return 1;case q.IPCSemiSphere:case q.CameraSemiSphere:return 2}return 0}function d(a,b){return null===a?b:a!=b||"part"===a||"part"==b?"part":a}function e(a,b,e){var f=[[],[],[]],g="all"==b,h=[null,null,null],i=null;0===a.length&&(i="all"==b?"selected":""),IX.iterate(a,function(a){var e=c(a.type),i=a.id,j=g||i in b?"selected":"";h[e]=d(h[e],j),f[e].push({chkClz:j,id:a.id,name:a.name})}),e&&(f[0]=[],f[2]=[]);var j=IX.loop(f,[],function(a,b,c){if(0===b.length)return a;var e=g?"selected":h[c];return i=d(i,e),a.push({chkClz:e,name:r[c],items:b}),a});return{selected:i,data:j}}function f(a,b,c,d){var f=e(b,c,d),g="all"==c;return{selected:g?"selected":f.selected,data:{name:a,chkClz:g?"selected":f.selected,expClz:"expanded",types:f.data}}}function g(a,b,c,e,g){var h="all"==c?"all":IX.loop(c,{},function(a,b){return a[b]=!0,a}),i=b,j=null;g&&b.length>0&&(i=IX.loop(i,[],function(a,b){for(var c=b.cameras,d=[],e=0;e<c.length;e++){var f=b.cameras[e];(22==f.type||33==f.type)&&d.push(f)}return d.length>0&&a.push({name:b.name,cameras:d}),a}));var k=IX.map(i,function(a){var b=f(a.name,a.cameras,h,g);return j=d(j,b.selected),b.data}),l=e&&e.get(a);return 0===k.length&&(j="all"==c?"selected":""),{selected:j,data:{id:a,name:l?l.name:"",chkClz:j,expClz:"expanded",zones:k}}}function h(a,b,c,e){var f=TCM.Env.getSession().getCurrentSiteType()==m.OCC,h="all"==b,i=h?{}:IX.loop(b,{},function(a,b){return a[b[0]]=h?"all":b[1],a}),j=null,k=IX.map(a,function(a){var b=a[0],f=a[1],h=g(b,f,i[b]||[],c,e);return j=d(j,h.selected),h.data});if(0===a.length){var l=TCM.Env.getSession().getCurrentSite().name,n=TCM.Env.getSession().getCurrentSite().id,o={chkClz:"part",expClz:"",id:n,name:l};return p.renderData("sites",o)}return p.renderData(f?"":"sites",f?{chkClz:j,expClz:"expanded",sites:k}:k[0])}function i(a){var b=jQuery(a).find(".item>.selected");if(0===b.length)return[];var c=IX.map(b,function(a){return $XD.dataAttr(a,"key")});return{ids:c}}function j(a,b,d){var e=[[],[],[]];return IX.iterate(a,function(a){var b=c(a.type);e[b].push({action:d?d:"camera.check",chkClz:"",id:a.id,name:a.name,type:a.type})}),IX.loop(e,[],function(a,b,c){return 0===b.length?a:(a.push({clz:"cameras"+c,action:d?d:"camera.check",chkClz:"",expClz:"expanded",name:r[c],type:0===c?20:1===c?22:21,items:b}),a)})}function k(a,b,c){var d=j(a,b,c);return u.renderData("",{types:d})}var l=(TCM.Global.sysCaller,IXW.Actions.configActions),m=TCM.Const.SiteTypes,n=(NV.Dialog.show,NV.Dialog.hide,NV.Lib.getCheckboxHTML,new IX.ITemplate({tpl:['<div class="leaf {clz}">','<a class="nv-checkbox {chkClz}" data-href="$cameraTree.check" data-key="{key}">','<span class="ixpic-"></span><span class="text">{name}</span></a>',"</div>",""]})),o=new IX.ITemplate({tpl:['<div class="leaf {clz}">','<a class="nv-checkbox {chkClz}" data-href="$cameraTree.check" data-key="{key}">','<span class="ixpic-"></span><span class="text">{name}</span></a>','<a class="nv-collapse {expClz}" data-href="$cameraTree.expand">','<span class="pic-"></span></a>',"</div>",""]}),p=new IX.ITemplate({tpl:['<div class="node line-cameras {expClz}">',o.renderData("",{clz:"line",key:"",name:"全线路"}),'<tpl id="sites">','<div class="node site-cameras {expClz}">',o.renderData("",{clz:"site",key:"{id}"}),'<tpl id="zones">','<div class="node zone-cameras {expClz}">',o.renderData("",{clz:"zone",key:""}),'<tpl id="types">','<div class="node type-cameras">',n.renderData("",{clz:"type",key:"type"}),'<tpl id="items">',n.renderData("",{clz:"item",key:"{id}"}),"</tpl>","</div>","</tpl>","</div>","</tpl>","</div>","</tpl>","</div>",""]});l([["cameraTree.check",function(b,c){var d=!$XH.hasClass(c,"selected"),e=jQuery(c.parentNode.parentNode);if(""===b.key&&0===jQuery(c.parentNode).next().length)return void NV.Dialog.alert("该分区下没有摄像机，授权失败！");if($XH.hasClass(c.parentNode,"item")){$XH.toggleClass(c,"selected"),jQuery(c)[d?"addClass":"removeClass"]("part");for(var f=e.find("div.item a"),g=0,h=f.length,i=0;h>i;i++)$XH.hasClass(f[i],"selected")&&(g+=1);g==h&&(e.find(".type .nv-checkbox").addClass("selected"),e.find(".type .nv-checkbox").addClass("part")),g>0&&g!=h&&(e.find(".type .nv-checkbox").removeClass("selected"),e.find(".type .nv-checkbox").addClass("part")),0===g&&(e.find(".type .nv-checkbox").removeClass("selected"),e.find(".type .nv-checkbox").removeClass("part"))}else e.find(".nv-checkbox")[d?"addClass":"removeClass"]("selected"),e.find(".nv-checkbox")[d?"addClass":"removeClass"]("part");a(e)}],["cameraTree.expand",function(a,b){return $XH.hasClass(b.parentNode,"site")&&!b.parentNode.nextSibling?void NV.Dialog.alert("该站点下没有摄像机！"):($XH.toggleClass(b,"expanded"),void $XH.toggleClass(b.parentNode,"expanded"))}]]);var q=TCM.Const.DeviceTypes,r=["枪机","球机","半球机"],s=new IX.ITemplate({tpl:['<div class="leaf {clz}">','<a class="nv-checkbox {chkClz}" data-type="{type}" data-href="${action}" data-key="{key}">','<span class="ixpic-"></span><span class="text">{name}</span></a>',"</div>",""]}),t=new IX.ITemplate({tpl:['<div class="leaf {clz}">','<a class="nv-checkbox {chkClz}" data-href="${action}" data-type="{type}">','<span class="ixpic-"></span><span class="text">{name}</span></a>','<a class="nv-collapse {expClz}" data-href="$camera.expand">','<span class="pic-"></span></a>',"</div>",""]}),u=new IX.ITemplate({
tpl:['<tpl id="types">',t.renderData("",{clz:"type",type:"{type}"}),'<div class="node type-cameras {clz}">','<tpl id="items">',s.renderData("",{clz:"item",key:"{id}"}),"</tpl>","</div>","</tpl>",""]});l([["camera.check",function(a,b){var c=!$XH.hasClass(b,"selected"),d=jQuery(b.parentNode);if($XH.hasClass(b.parentNode,"item")){$XH.toggleClass(b,"selected");for(var e=d.parent().find(".nv-checkbox"),f=0,g=e.length,h=0;g>h;h++)$XH.hasClass(e[h],"selected")&&(f+=1);f==g&&(d.parent().prev().find(".nv-checkbox").removeClass("part"),d.parent().prev().find(".nv-checkbox").addClass("selected")),f>0&&f!=g&&(d.parent().prev().find(".nv-checkbox").removeClass("selected"),d.parent().prev().find(".nv-checkbox").addClass("part")),0===f&&(d.parent().prev().find(".nv-checkbox").removeClass("selected"),d.parent().prev().find(".nv-checkbox").removeClass("part"))}else $XH.toggleClass(b,"selected"),jQuery(b)[c?"addClass":"removeClass"]("part"),d.next().find(".nv-checkbox")[c?"addClass":"removeClass"]("selected")}],["camera.expand",function(a,b){$XH.toggleClass(b,"expanded"),$XH.toggleClass(b.parentNode,"expanded");var c=$XH.ancestor(jQuery(b.parentNode).siblings(".type").get(0),"expanded");c&&($XH.toggleClass(c,"expanded"),$XH.toggleClass($XH.first(c,"nv-collapse"),"expanded"));var d=$XH.ancestor(jQuery(b.parentNode).siblings(".type").get(1),"expanded");d&&($XH.toggleClass(d,"expanded"),$XH.toggleClass($XH.first(d,"nv-collapse"),"expanded"))}]]),IX.ns("TCM.Lib"),TCM.Lib.CameraTree={getCameraTreeHTML:function(a,b,c,d){return h(a,b,c,d)},getCameraAccess:function(a){return b(a)},getCamera4TypesHTML:function(a,b,c){return k(a,b,c)},getCamera4TypeAccess:function(a){return i(a)}}}(),function(){function a(a){switch(a){case x.IPCFixed:case x.CameraFixed:return 0;case x.IPCSphere:case x.CameraSphere:return 1;case x.IPCSemiSphere:case x.CameraSemiSphere:return 2}return 0}function b(b,c){var d=[[],[],[]];return IX.iterate(b,function(b){var c=a(b.type);b.id;d[c].push({type:b.type,chkClz:"lost",id:b.id,name:b.name})}),IX.loop(d,[],function(a,b,c){return 0===b.length?a:(a.push({clz:"cameras"+c,expClz:"expanded",name:y[c],items:b}),a)})}function c(a,c){var d=b(a,c);return w.renderData("",{types:d})}function d(){return z?void 0:(z=IXW.Lib.FileUploader,TCM.Global.filUploadUrl?void z.init(TCM.Global.filUploadUrl):t("没有配置检索图片上传路径，文件无法上传"))}function e(a,b,c){function e(a){var c=a&&"files"in a?a.files[0]:null;return c&&c.type.indexOf("image")<0?t("这里只能上传图片，谢谢！"):c&&c.size>104857600?t("请不要上传大于 100MB 的图片，谢谢！"):(g=!0,jQuery('<div id="mask"></div>').appendTo(jQuery(document.body)),IXW.Lib.info("正在上传地图，请稍等...","exist",-1),void f.submit(function(a){return g=!1,a.message?(jQuery("#mask").remove(),jQuery(".ixw-info").remove(),void t(a.message)):void b(a)}))}d();var f=null,g=!1,h={trigger:a,onchange:e};IX.isString(c)&&(h.fileUploadURL=c),f=new z(h);var i=jQuery(".chooseBar").attr("data-zoneid");jQuery("form").append('<input type="hidden" name="zoneId" value="'+i+'">')}function f(a){function b(a){for(var b=0;b<f.length;b++)if(f[b].id==a.id)return f[b].x=a.x,void(f[b].y=a.y)}var c=a.width,d=a.height,e=a.url,f=a.cameras||[];return{getData:function(){return{width:c,height:d,url:e,cameras:f}},resetData:function(a){c=a.width,d=a.height,e=a.url},editCamera:b,addCamera:function(a){f.push(a)},deleteCamera:function(a){for(var b=0;b<f.length;b++)if(f[b].id==a)return f.splice(b,1)}}}function g(a,b){function c(a){var b=$X("Grid").clientHeight;$X("Tree").style.height=b+"px",$X("imgFrame")&&($X("imgFrame").style.height=b-110+"px"),m=w.width(),p=w.height(),n=m/2,q=p/2,v.css("top","0px"),a?jQuery(".nv-tree").css("maxHeight",b-55+"px"):jQuery(".nv-tree").css("maxHeight",b-85+"px")}function d(){v.css({width:l+"px",height:o+"px",left:-1*(n-m/2)+"px",top:b.height<p?(p-o)/2+"px":-1*(q-p/2)+"px"}),jQuery(".cameraOne").each(function(){var a=$XD.dataAttr(this,"key");jQuery(this).css({top:Math.floor(r[a].multipleY*o)+"px",left:Math.floor(r[a].multipleX*l)+"px"})})}function e(c){if($X("image").src){if(jQuery("#imgFrame").width()>a.width||jQuery("#imgFrame").height()>a.height)return b.width=a.width,void(b.height=a.height);var e,f;1===c?(e=Math.min(1.2*l,j),f=Math.min(1.2*o,k)):(e=Math.max(.8*l,m),f=.8*o,e==m&&(f=k*e/j)),t=p>f?!0:!1,n=Math.min(Math.max(n*e/l,m/2),l-m/2),q=Math.min(Math.max(q*f/o,p/2),o-p/2),l=e,o=f,b.width=e,b.height=f,d()}}function g(a){return s?!0:(s=!0,e(a.wheelDelta>0||a.detail<0?1:0),s=!1,void(a.returnValue=!1))}function h(){var a=u.getData();j=a.width,k=a.height,l=j,o=k,m=w.width(),p=w.height(),n=m/2,q=p/2,IX.iterate(a.cameras,function(b,c){var d=Math.min(a.width,b.x),e=Math.min(a.height,b.y);r[b.id]={top:e,left:d,multipleX:d/j,multipleY:e/k}}),d()}function i(a,b){r[a.id]={top:a.y,left:a.x,multipleX:a.x/j,multipleY:a.y/k},u[b](a)}var j,k,l,m,n,o,p,q,r={},s=!1,t=!1,u=new f(a),v=jQuery(".fix"),w=jQuery("#imgFrame");jQuery(".zoom"),jQuery(".suspend");return h(),{resetCamera:function(a,b){i(a,b)},deleteCamera:function(a){r[a]="",u.deleteCamera(a)},refresh:function(b){u.resetData(b),a=b,h()},scrollIt:g,zoom:e,resize:c,resetCenter:function(a,b){n=a,q=b},ratioX:function(){return j/l},ratioY:function(){return k/o},isSmall:function(){return t},widthFrame:function(){return m},heightFrame:function(){return p}}}function h(a,b,c,d){var e=jQuery(c),f={id:e.attr("data-key"),x:Math.floor(parseInt(e.css("left"))*A.ratioX()),y:Math.floor(parseInt(e.css("top"))*A.ratioY())};r(d,f,function(a){return"addDeviceOfMap"==d?(A.resetCamera(f,"addCamera"),void jQuery(".suspend").css({visibility:"visible"})):(A.resetCamera(f,"editCamera"),void i())})}function i(){jQuery(".suspend").fadeToggle(200)}function j(a){a||jQuery(".cameraOne").draggable(B),jQuery(".fix").droppable().draggable({stop:function(a,b){var c=jQuery(this),d=Math.floor(c.width())-A.widthFrame(),e=Math.floor(c.height())-A.heightFrame();A.isSmall()?c.css({top:Math.min(Math.max(0,b.position.top),-1*(e-1))+"px"}):c.css({top:Math.min(Math.max(-1*(e-1),b.position.top),0)+"px"}),c.css({left:Math.min(Math.max(-1*(d-1),b.position.left),0)+"px"}),A.resetCenter(-1*parseInt(c.css("left"))+A.widthFrame()/2,-1*parseInt(c.css("top"))+A.heightFrame()/2)}}),jQuery(".suspend").draggable({containment:"parent"})}function k(){var a,b;jQuery(".lost").draggable({helper:"clone",cancel:".name",start:function(c,d){$XH.hasClass(c.toElement,"name")?(a=c.offsetX+32,b=c.offsetY+6):(a=c.offsetX,b=c.offsetY),jQuery(".suspend").css({visibility:"hidden"}),d.helper.css("visibility","visible")},stop:function(c,d){var e=jQuery(this),f=jQuery(this.parentNode),g=jQuery(".fix").get(0).getBoundingClientRect();e.removeClass("lost").addClass("cameraOne").appendTo(".fix").attr({style:"top:"+Math.min(Math.max(0,c.pageY-g.top-b+14),g.height-30)+"px; left:"+Math.min(Math.max(0,c.pageX-g.left-a+14),g.width-30)+"px;"}),e.draggable("destroy"),1===f.find(".lost").length&&(1===f.parent().find(".lost").length&&(f.parent().get(0).innerHTML='<span class="hint">没有未指定坐标的摄像机！</span>'),f.prev().remove(),f.remove()),h(c,d,this,"addDeviceOfMap"),setTimeout(function(){jQuery(".fix>:last").draggable(B)},0),p(-1)}})}function l(a){r("getCamerasNotInMap",a,function(a){o(a.length||0);var b=c(a,[20,21,22,31,32,33]);b||(b='<span class="hint">没有未指定坐标的摄像机！</span>');var d=$X("content");d.innerHTML="<div>"+b+"</div>",IX.bind($XD.first(d,"div"),{click:function(a){if(!$XD.ancestor(a.target,"a")){var b=$XH.ancestor(a.target,"type");jQuery(b).siblings(".type").removeClass("expanded"),$XH.toggleClass(b,"expanded"),jQuery(".suspend").css("top",Math.min(parseInt(jQuery(".suspend").css("top")),parseInt(jQuery("#imgFrame").css("height"))-172)+"px")}},mousedown:function(a){a.cancelBubble=!0}}),k()})}function m(a,b){b.width=a.width,b.height=a.height,A?A.refresh(a):A=new g(a,b)}function n(a,b,c){IX.isFirefox?b.addEventListener("DOMMouseScroll",A.scrollIt,!1):b.onmousewheel=A.scrollIt;var d=jQuery(".notCameras"),e=jQuery(".suspend"),f=jQuery("#content");e.hover(function(b){$XH.hasClass(d.get(0),"showContent")||(l(a),e.animate({opacity:.01},200,function(){d.addClass("showContent"),f.css({display:"block"}),jQuery(this).animate({opacity:1},200)}))}),IX.bind(jQuery(".nvgrid-body").get(0),{click:function(a){$XH.ancestor(a.target,"suspend")||$XH.hasClass(d.get(0),"showContent")&&e.animate({
opacity:.01},200,function(){d.removeClass("showContent"),f.css({display:"none"}),jQuery(this).animate({opacity:1},200)})}}),j(c),$Xw.bind({resize:function(){A.resize(c)}})}function o(a){jQuery(".notCameras .count").html("("+a+")")}function p(a){var b=jQuery(".notCameras .count"),c=b.html();b.html("("+(Number(c.slice(1,c.length-1))+a)+")")}function q(a,b,c){function d(d,f){$X(a).innerHTML=D.renderData("",{imgURL:"",cameras:d.cameras||[]}),r("getCamerasNotInMap",b,function(a){o(a.length||0)}),$X("imgFrame").style.height=f-110+"px";var g=$X("image"),h=d,i=!1;return g.onload=function(){m(h,g),jQuery("#mask").remove(),i||(n(b,g,c),i=!0)},g.src=d.url?TCM.Global.getMapUrl(d.url):"",c?(jQuery(".suspend").css("display","none"),jQuery("#updateFile").css("visibility","hidden"),void jQuery(".showMap").addClass("occ")):void e("updateFile",function(a){h=a,g.src=TCM.Global.getMapUrl(a.url),IXW.Lib.info("地图上传成功！")},TCM.Global.filUploadUrl)}return{show:function(){var a=$X("Grid").clientHeight;$X("Tree").style.height=a+"px",r("getMap",b,function(b){if(!b.url){if(c)return jQuery(".nvgrid-body").html("").css("height",jQuery("#Tree").height()),t("该分区暂未上传地图！");t("地图不存在，请上传地图！")}d(b,a)})}}}var r=TCM.Global.deviceAndZoneCaller,s=IXW.Actions.configActions,t=NV.Dialog.alert,u=new IX.ITemplate({tpl:['<div class="c{type} {chkClz}" data-key="{id}" data-type="{type}">','<div class="name" title="{name}">{name}</div>','<a class="delete" data-href="$delete.cameraXY" data-key="{id}"></a>',"</div> ",""]}),v=new IX.ITemplate({tpl:['<div class="leaf {clz}">','<span class="text">{name}</span>','<a class="nv-collapse {expClz}" data-href="$mapCamera.expand">','<span class="pic-"></span></a>',"</div>",""]}),w=new IX.ITemplate({tpl:['<tpl id="types">',v.renderData("",{clz:"type",key:"type"}),'<div class="node type-cameras {clz}">','<tpl id="items">',u.renderData("",{clz:"item",key:"{id}"}),"</tpl>","</div>","</tpl>",""]}),x=TCM.Const.DeviceTypes,y=["枪机","球机","半球机"],z=null,A=null,B={revert:"invalid",start:i,stop:function(a,b){h(a,b,this,"editDeviceOfMap")}},C=new IX.ITemplate({tpl:['<div class="cameraOne c{type}" data-key="{id}" data-type="{type}" style="top: {y}px; left: {x}px;">','<div class="name">{name}</div>','<a class="delete" data-href="$delete.cameraXY" data-key="{id}"></a>',"</div> ",""]}),D=new IX.ITemplate({tpl:['<a id="updateFile">选择地图文件</a>','<div class="zoom">','<a data-href="$img.shrink" class="shrink"></a>','<a data-href="$img.add" class="add"></a>',"</div>",'<div class="suspend">','<a class="notCameras">未指定坐标的摄像机&nbsp;<span class="count"></span></a>','<div id="content" class="tri-title"></div>',"</div>",'<div id="imgFrame">','<div class="fix">','<img id="image" src="{imgURL}">','<tpl id="cameras">',C.getTpl(),"</tpl>","</div>","</div>",""]});s([["delete.cameraXY",function(a,b){var c=a.key;r("deleteDeviceOfMap",{id:c},function(a){jQuery(b.parentNode).remove(),A.deleteCamera(c),p(1)})}],["img.add",function(a,b){A.zoom(1)}],["img.shrink",function(a,b){A.zoom(0)}],["mapCamera.expand",function(a,b){$XH.toggleClass(b,"expanded"),$XH.toggleClass(b.parentNode,"expanded");var c=$XH.ancestor(jQuery(b.parentNode).siblings(".type").get(0),"expanded");c&&($XH.toggleClass(c,"expanded"),$XH.toggleClass($XH.first(c,"nv-collapse"),"expanded"));var d=$XH.ancestor(jQuery(b.parentNode).siblings(".type").get(1),"expanded");d&&($XH.toggleClass(d,"expanded"),$XH.toggleClass($XH.first(d,"nv-collapse"),"expanded")),jQuery(".suspend").css("top",Math.min(parseInt(jQuery(".suspend").css("top")),parseInt(jQuery("#imgFrame").css("height"))-172)+"px")}]]),IX.ns("TCM.Lib"),TCM.Lib.Map=function(a,b,c){return A=null,new q(a,b,c)}}(),function(){function a(){if("entry"==c.getCurrentName()){var a=window.innerWidth,b=window.innerHeight,g=(document.body.clientWidth,Math.max(a/d,b/e)),h=jQuery(".bg img");h.css({width:Math.round(d*g)+"px",height:Math.round(e*g)+"px"}),jQuery(".container").css("bottom",Math.max(0,Math.round((b-f)/2))+"px")}}var b=new IX.ITemplate({tpl:['<div class="bg"><img src="{background}"></div>','<div class="container">','<div class="pic_top">','<div class="pic_char"></div>',"</div>","<ul>",'<li><span class="pic-user"></span><span class="verLine"></span><input type="text" id="account" tabindex="1" placeholder="账号"></li>','<li><span class="pic-pwd"></span><span class="verLine"></span><input type="password" id="password" tabindex="2" placeholder="密码"></li>',"</ul>",'<a id="submit" tabindex="3" class="btn longbtn" data-href="$login"><span>立即登录</span></a>',"</div>",'<div class="footer" id="footer"><span class="footer-bar"></span></div>',""]}),c=IXW.Pages;IXW.Actions.configActions([["login",function(){var a=$X("account").value,b=$X("password").value;return a.isWindowsDirectory()&&b.isWindowsDirectory()?void TCM.Global.entryCaller("login",{username:a,password:b},function(a){TCM.Env.resetSession(a),c.load("")}):NV.Dialog.alert('账号密码中请勿包含\\/^:*><|@?"特殊字符！')}]]);var d=1939,e=1175,f=300;$Xw.bind({resize:a}),IX.ns("TCM.Entry"),TCM.Entry.init=function(d,e,f){if(TCM.Env.hasSession())return c.load("");document.body.innerHTML=b.renderData("",{background:TCM.Global.backgroundUrl}),a(),jQuery("input").bind({focus:function(a){$XH.addClass($XD.ancestor(this,"li"),"focus")},blur:function(a){$XH.removeClass($XD.ancestor(this,"li"),"focus")}});var g=$X("submit");$X("account").focus(),jQuery("#account").bind("keydown",function(a){13==a.which&&$X("password").focus()}),jQuery("#password").keydown(function(a){13==a.keyCode&&(g.click(),$X("account").blur(),$X("password").blur())})}}(),function(){IX.ns("TCM.ErrPage"),TCM.ErrPage.init=function(a,b,c){document.body.innerHTML="ERROR"}}(),function(){function a(a,b,c){var d=a.length,e=[],f=IX.map(a,function(a){return e.push(a.get("name")),a.getId()});o(b.title,w.renderData("",{count:d+b.unitName}),function(a){k(b.callerName,{ids:f},function(){a(),c()})})}function b(a){var b=/^[0-9_a-zA-Z]{1,20}$/;return b.test(a)}function c(a,c,e){if("no"==e){var f=d(a);if(!f)return p("请输入有效的数字编号！"),!1}if("password"==e&&""!==a){var g=b(a);if(!g)return p("密码只允许数字、字母和下划线，且最长为20位！"),!1}return!0}function d(a){var b=/^\d+$/;return b.test(a)}function e(a){var b=/^([A-Z]|[0-9]|[\u4E00-\u9FA5])*$/,c=b.test(a);return c?!0:(p("站点名只允许为大写英文，数字和汉字的混合!"),!1)}function f(a,b){for(var d={},e=!1,f=!1,g=0;g<b.length;g++){var h=b[g],i=$X(h.key).value;if("null"==i)return p(h.empty),!1;if("bool"==h.type&&(i="true"==i),IX.isEmpty(i)&&!IX.isEmpty(h.empty))return p(h.empty),!1;if(!c(i,h.empty,h.name))return!1;e=e||!(a&&a.get(h.name)==i),a&&a.get(h.name)!=i&&"site_type"==h.key&&jQuery(".sys-editSite").length>0&&(f=!0),IX.setProperty(d,h.name,i)}return e?(a&&(d.id=a.getId()),d.typeChange=f,d):(q("您未作任何修改，请点击取消关闭编辑窗口！"),!1)}function g(a,b,c){function d(){var d=f(a,g);if("sys-editSite"==b.clz&&d.name){var h=e(d.name);if(!h)return!1}if(d.account&&!d.account.isWindowsDirectory())return p(IX.encodeTXT('登录账号中请勿包含\\/^:*><|@?"特殊字符！'));if(d.name&&"sys-editSite"!=b.clz&&!d.name.isWindowsDirectory())return p(IX.encodeTXT('名称中请勿包含\\/^:*><|@?"特殊字符！'));var i=$XP(b,"checkInfo");!d||IX.isFn(i)&&!i(d)||k(b.callerName,d,function(b){a&&a.getId()==TCM.Env.getSession().getCurrentSiteId()&&jQuery(".sys-editSite").length>0&&jQuery(".nowSite").children(".name").html(d.name),n();var e="id"in d?d.id:b.id;c({ids:[e]}),d.typeChange&&TCM.Env.reloadSession()})}for(var g=b.checkers,h={},i=0;i<g.length;i++){var j=g[i],l=j.type,o=a&&(a.get(j.name)||0===a.get(j.name))?a.get(j.name):"";h[j.key]="bool"==l?o:(o+"").dehtml()}m({clz:b.clz,title:b.title,content:b.tpl.renderData("",b.tpldataFn(a,h)),listen:{ok:d}})}function h(a,b,c){var d=$XH.ancestor(c,"dropdown");if(d){var e=$XD.first(d,"input");e.value=a;var f=$XH.first($XH.first(d,"dropdown-toggle"),"name");f.innerHTML=b}}function i(a,b){var c=IX.isEmpty(b)?2:b;return s(a,{value:c,valueText:F[c],items:G})}function j(a,b){var c=IX.isEmpty(b)?1:b,d=[];return d.push(G[0]),s(a,{value:c,valueText:F[c],items:d})}var k=TCM.Global.sysCaller,l=IXW.Actions.configActions,m=NV.Dialog.show,n=NV.Dialog.hide,o=NV.Dialog.confirm,p=NV.Dialog.alert,q=IXW.Lib.info,r=(IXW.Pages,NV.Lib.getCheckboxHTML),s=NV.Lib.getComboHTML,t=TCM.Lib.getSiteTypeComboHTML,u=TCM.Lib.getRoleComboHTML,v=TCM.Lib.CameraTree,w=new IX.ITemplate({
tpl:["确认要删除这{count}吗？<br>",""]});IX.ns("TCM.SysDialog");var x=new IX.ITemplate({tpl:["<ul>",'<li><span class="label">编号</span>','<span><input id="site_no" maxlength="8" value="{site_no}"></span></li>','<li><span class="label">名称</span>','<span><input id="site_name" maxlength="32" value="{site_name}"></span></li>','<li><span class="label">类型</span>{siteId}{siteTypeCombo}</li>','<li><span class="label">说明</span>','<span><input id="site_desc" maxlength="150" value="{site_desc}"></span></li>',"</ul>",""]}),y=new IX.ITemplate({tpl:["<ul>",'<li><span class="warn">只能修改一次，请慎重！(修改后需重新登录)</span></li>','<li id="site-set"><span>当前单位</span>{siteCombo}</li>',"</ul>",""]}),z={clz:"sys-editSite",tpl:x,tpldataFn:function(a,b){return b.siteTypeCombo=t("site_type",b.site_type),b.siteId='<input id="site_id" type="hidden" value="'+b.site_id+'">',b},checkers:[{name:"no",key:"site_no",empty:"请输入单位编号！"},{name:"name",key:"site_name",empty:"请输入单位名称！"},{name:"desc",key:"site_desc",empty:""},{name:"type",key:"site_type",empty:""},{name:"id",key:"site_id",empty:""}]};TCM.SysDialog.editSite=function(a,b){g(a,IX.inherit(z,{title:"编辑单位",callerName:"editSite"}),b)},TCM.SysDialog.createSite=function(a){g(null,IX.inherit(z,{title:"新建单位",callerName:"createSite"}),a)},TCM.SysDialog.deleteSites=function(b,c){a(b,{title:"删除单位",unitName:"个单位",callerName:"deleteSites"},c)},TCM.SysDialog.setCurrentSite=function(a,b,c){function d(){var a=$X("setSite").value-0;a?k("setCurrentSite",{id:a},function(){n(),TCM.Global.entryCaller("logout",{},function(){TCM.Env.clearSession()})}):p("设置当前站点失败，不能为空！")}m({clz:"",title:"设置",content:y.renderData("",{siteCombo:s("setSite",{value:"",valueText:"",items:IX.map(c,function(a){return{id:a.id,name:a.name}})})}),listen:{ok:d}})};var A=new IX.ITemplate({tpl:["<ul>",'<li><span class="label">角色名称</span>','<span><input id="role_name" maxlength="32" value="{role_name}"></span></li>','<li><span class="label">所属单位类型</span>{siteTypeCombo}</li>',"<li>{rolePromptableCheckBox}</li>","</ul>",""]}),B={clz:"sys-editRole",tpl:A,tpldataFn:function(a,b){return b.siteTypeCombo=t("site_type",b.site_type),b.rolePromptableCheckBox=r("role_promptable",!!b.role_promptable,"特殊情况下允许启动临时授权"),b},checkers:[{name:"name",key:"role_name",empty:"请输入角色名称！"},{name:"siteType",key:"site_type",empty:"请确定角色适用的人员所在单位！"},{name:"promptable",key:"role_promptable",type:"bool",empty:""}]};TCM.SysDialog.editRole=function(a,b){g(a,IX.inherit(B,{title:"编辑用户角色",callerName:"editRole"}),b)},TCM.SysDialog.createRole=function(a){g(null,IX.inherit(B,{title:"新建用户角色",callerName:"createRole"}),a)},TCM.SysDialog.deleteRoles=function(b,c){a(b,{title:"删除角色",unitName:"个角色",callerName:"deleteRoles"},c)};var C=new IX.ITemplate({tpl:["<ul>",'<li><span class="label">类别</span><span class="level">{level}</span></li>','<li><span class="label">对应角色（车站)</span>{stationRoleCombo}</li>',"<li>{stationPromptedCheckbox}</li>",'<li><span class="label">对应角色（车辆段）</span>{depotRoleCombo}</li>',"<li>{depotPromptedCheckbox}</li>","</ul>",""]}),D={clz:"sys-editLevel",tpl:C,tpldataFn:function(a,b){return b.level=a.get("name"),b.stationRoleCombo=u("station_role",b.station_role,!0),b.stationPromptedCheckbox=r("station_prompted",!!b.station_prompted,"允许临时权限提升"),b.depotRoleCombo=u("depot_role",b.depot_role,!0),b.depotPromptedCheckbox=r("depot_prompted",!!b.depot_prompted,"允许临时权限提升"),b},checkers:[{name:"station.id",key:"station_role",empty:"请选择车站对应的角色！"},{name:"station.prompted",key:"station_prompted",type:"bool",empty:""},{name:"depot.id",key:"depot_role",empty:"请选择车辆段对应的角色！"},{name:"depot.prompted",key:"depot_prompted",type:"bool",empty:""}]};TCM.SysDialog.editLevel=function(a,b){g(a,IX.inherit(D,{title:"编辑用户优先级",callerName:"editUserLevel"}),b)};var E=new IX.ITemplate({tpl:['<ul class="{clz}">','<li><span class="label">所属单位</span>','<input type="hidden" id="user_site" value="{user_site}"><span>{siteName}</span></li>','<li><span class="label">用户类型</span>{userTypeCombo}</li>','<li><span class="label">用户名</span>','<span><input id="user_name" maxlength="32" value="{user_name}"></span></li>','<li><span class="label">登录账号</span>','<span><input id="user_account" maxlength="32" value="{user_account}"></span></li>','<li class="pwd"><span class="label">登录密码</span>','<span><input maxlength="16" id="user_pwd"></span></li>','<li class="role"><span class="label">用户角色</span>{roleCombo}</li>','<li><span class="label">说明</span>','<span><input id="user_desc" maxlength="150" value="{user_desc}"></span></li>',"</ul>",""]});l([["sys.changeUserType",function(a,b){var c=a.key,d=b.innerHTML,e=$XH.ancestor(b,"dropdown");if(e){var f=$XD.first(e,"input");f.value=c;var g=$XH.first($XH.first(e,"dropdown-toggle"),"name");g.innerHTML=d;var h=$XD.ancestor(e,"ul");h.className=1==c?"isAdmin":"isUser"}}],["sys.changeSiteType",function(a,b){var c=a.key,d=b.innerHTML,e=jQuery(".sys-editSite").length>0&&"编辑单位"==jQuery(".head").text()&&jQuery(".sys-editSite .dropdown").find("input").attr("value")!=c;e?k("hasData",{id:$X("site_id").value,toType:c},function(a){return a.msg?p(a.msg):void h(c,d,b)}):h(c,d,b)}]]);var F=TCM.Const.UserTypeNames,G=IX.map(F,function(a,b){return{id:b,name:a,action:"sys.changeUserType"}});G.shift();var H={clz:"sys-editUser",tpl:E,tpldataFn:function(a,b){var c=TCM.Env.getSession().isSuper();return b.user_desc=b.user_desc||"",b.user_site=b.user_site||TCM.Env.getSession().getCurrentSiteId(),b.siteName=TCM.LineInfo.getSiteName(b.user_site),a?b.userTypeCombo='<span><input disabled id="user_type" maxlength="32" value="'+F[b.user_type]+'"></span>':b.userTypeCombo=c?j("user_type",b.user_type):i("user_type",b.user_type),b.clz=c?"isAdmin":1==b.user_type?"isAdmin":"isUser",b.roleCombo=u("user_role",b.user_role,!1),b},checkers:[{name:"siteId",key:"user_site",empty:""},{name:"type",key:"user_type",empty:""},{name:"name",key:"user_name",empty:"请输入用户名称！"},{name:"account",key:"user_account",empty:"请确定用户登录账号！"},{name:"role",key:"user_role",empty:""},{name:"password",key:"user_pwd",empty:""},{name:"desc",key:"user_desc",empty:""}]};TCM.SysDialog.editUser=function(a,b){g(a,IX.inherit(H,{checkInfo:function(a){return 2==a.type&&""===a.role?(p("普通用户必须赋予角色以便确定操作权限！"),!1):(a.account==TCM.Env.getSession().getAccount()&&TCM.Env.getSession().setUserName(a.name),!0)},title:"编辑用户",callerName:"editUser"}),b)},TCM.SysDialog.createUser=function(a){g(null,IX.inherit(H,{checkInfo:function(a){return 2==a.type&&""===a.role?(p("普通用户必须赋予角色以便确定操作权限！"),!1):IX.isEmpty(a.password)?(p("请输入用户的初始密码！"),!1):!0},clz:"sys-editUser sys-createUser",title:"新建用户",callerName:"addUser"}),a)},TCM.SysDialog.deleteUsers=function(b,c){a(b,{title:"删除用户",unitName:"个用户",callerName:"deleteUsers"},c)};var I=new IX.ITemplate({tpl:["<ul>",'<li><span class="label">新密码</span><span><input id="user_pwd" value=""></span></li>',"</ul>",""]}),J=new IX.ITemplate({tpl:['<div class="cameras">',"<h6>允许查看实时视频</h6>",'<div id="vsvTree" class="camera-tree vsv">{cameraTree4VSV}</div>',"<h6>允许云台控制</h6>",'<div id="ptzcTree" class="camera-tree ptzc">{cameraTree4PTZC}</div>',"</div>",'<div class="vra">{vraCheckbox}</div>',""]});TCM.SysDialog.chgpwd=function(a){function b(){var b=jQuery.trim($X("user_pwd").value);return IX.isEmpty(b)?p("用户密码不能设置为空！"):void(c(b,"","password")&&k("resetPwd",{id:a.getId(),password:b},function(){q("密码修改成功！"),n()}))}var d=a.get("name"),e=a.get("type");m({clz:"sys-chgpwd",title:"修改"+TCM.Const.UserTypeNames[e]+'"'+d+'"的登录密码',content:I.renderData(""),listen:{ok:b}})},TCM.SysDialog.chgpriv=function(a){function b(){k("resetPriv",{id:e,access:JSON.stringify({vsv:v.getCameraAccess($X("vsvTree")),ptzc:v.getCameraAccess($X("ptzcTree")),vra:"true"==$X("priv_vra").value})},function(){q("修改权限成功！"),n()})}function c(a){if(!$XD.ancestor(a.target,"a")){var b=$XH.ancestor(a.target,"leaf");if(b){if($XH.hasClass(b,"site")&&!b.nextSibling)return NV.Dialog.alert("该站点下无分区或分区下无相应摄像机，不能展开！");$XH.toggleClass(b,"expanded"),$XH.toggleClass($XH.first(b,"nv-collapse"),"expanded")}}}var d=TCM.LineInfo.getSites(),e=a.getId();a.get("name"),a.get("access");k("getAllCameras",{},function(a){k("getUserPriv",{id:e},function(e){m({clz:"sys-chgpriv",title:"用户管理/权限配置",content:J.renderData("",{cameraTree4VSV:v.getCameraTreeHTML(a,$XP(e,"vsv",[]),d,!1),
cameraTree4PTZC:v.getCameraTreeHTML(a,$XP(e,"ptzc",[]),d,!0),vraCheckbox:r("priv_vra",$XP(e,"vra"),"允许录像文件检索与回放")}),listen:{ok:b}}),IX.bind(jQuery(".cameras").get(0),{click:c}),e&&"all"==e.vsv&&jQuery("#vsvTree").find(".nv-checkbox").each(function(){jQuery(this).addClass("selected")}),e&&"all"==e.ptzc&&jQuery("#ptzcTree").find(".nv-checkbox").each(function(){jQuery(this).addClass("selected")})})})}}(),function(){function a(a,b){var c=!b||TCM.Env.canUpdateLineInfo(),d=(c&&a.hasCheckbox?["_checkbox"]:[]).concat(a.columns.split(",")),e=c?["refresh"].concat($XP(a,"buttons",[])):["refresh"];return new y($XP(a,"container","body"),{title:$XP(a,"title",""),rowModel:$XP(a,"rowModel"),grid:{clz:$XP(a,"clz",""),columns:d,actions:c?$XP(a,"actions",[]):[],usePagination:a.usePagination||!1,dataLoader:$XF(a,"dataLoader")},tools:{buttons:e},listen:a.listeners||{}})}function b(a){x.setName(a.name);var b=x.getSites(),c=a.sites;return b.refresh(c),d(c),c}function c(){return IX.encodeTXT(x.getSiteName(J))}function d(a){var b=$XH.first($X("body"),"sys-info");b&&(b.innerHTML=G.renderData("",{value:IX.encodeTXT(I),currentSiteName:c()}),c()&&jQuery(".setSite").css("display","none"))}function e(b){var c=null;I=x.getName(),J=C.getCurrentSiteId(),$X("body").innerHTML=H.renderData(""),c=a(IX.inherit(F.line,{actions:["delete",["edit","编辑",function(a,b){z.editSite(a,function(){c.refresh()})}]],listeners:{createItem:z.createSite,deleteItems:z.deleteSites}}),!0),b()}function f(b){var c=null;c=a(IX.inherit(F.role,{actions:["delete",["edit","编辑",function(a,b){z.editRole(a,function(){c.refresh()})}]],listeners:{createItem:z.createRole,deleteItems:z.deleteRoles}}),!0),b()}function g(b){var c=null;c=a(IX.inherit(F.level,{actions:[["reset","重置",function(a,b){return"预留"==jQuery(b).find(".col-role-name").html()?NV.Dialog.alert("此级别已为预留位，无需重置！"):IX.Array.isFound(a.getId(),[1,2,3,4,5,6,7,8,9,10,11,12])?NV.Dialog.alert("系统预置优先级不能重置！"):void NV.Dialog.confirm("提示","是否重置此级别优先级？",function(b){v("resetLevel",{id:a.getId()},function(a){b(),c.refresh()})})}],["edit","编辑",function(a,b){z.editLevel(a,function(){c.refresh()})}]]}),!0),b()}function h(a,b,c,d){var e=new IXW.Lib.GridModel.RowModelBase(a,b,c,d);return IX.inherit(e,{getTpldata:function(){var a=e.getTpldata();return a.clz=2==e.get("type")?"isUser":"",a}})}function i(b){function c(a,b){z.editUser(a,function(){d.refresh()})}var d=null,e=C.getCurrentSiteId();return-1===e?void A("未设置当前站点，不能添加用户！"):(d=a(IX.inherit(F.user,{rowModel:h,actions:["delete",["edit","编辑",c],["chgpriv","修改权限",z.chgpriv],["chgpwd","修改密码",z.chgpwd]],listeners:{createItem:z.createUser,deleteItems:z.deleteUsers}}),!1),void b())}function j(){v("setConfig",L,function(){B("配置修改已生效！")})}function k(){v("timingSetting",L,function(){B("配置修改已生效！")})}function l(a,b){var c=JSON.parse($XP(L,a));return $XP(c,b,!1)?"selected":""}function m(a){return"false"!=$XP(L,a)?"selected":""}function n(){D=TCM.Env.getSession().getCurrentSiteType(),E=1==D||4==D?!0:!1;var a=l("TimingSetting","autoTiming"),b=l("TimingSetting","useNTP");return{syncClz:m("Sync"),syncTxt:M[C.getCurrentSiteType()],controlTime:$XP(L,"ControlReleaseTime",3e3),timingClz:a,scheduleAttr:a?"":"disabled",scheduleTime:JSON.parse($XP(L,"TimingSetting")).schedule||"01:00:00",rs422Clz:l("TimingSetting","useRS422"),ntpClz:l("TimingSetting","useNTP"),ntpIP:JSON.parse($XP(L,"TimingSetting")).ntpIP||"",hostAttr:b?"":"disabled",ntpPort:JSON.parse($XP(L,"TimingSetting")).ntpPort||123,portAttr:b?"":"disabled",tvsClz:l("ServerBackupSetting","backupTVS"),ssClz:l("ServerBackupSetting","backupSS"),storageClz:m("StorageBackupSetting"),dispayInView:E?"displayNone":"displayBlock",dispayView:E?"":"displayNone",radioSite:E?"":"radioSite",controlTimeAttr:E?"":"disabled",cursor:E?"":"cursor",checkSite:E?"":"checkSite"}}function o(a,b,c,d){if(isNaN(a))return!1;var e=a-0;return b>e||e>c?!1:d?(e="0"+e,e.length-2>0?e.substring(e.length-2,e.length):e):!0}function p(a){var b=a.split(":");if(IX.isEmpty(b[0])||isNaN(b[0]))return!1;if(b[0]=o(b[0],0,23,!0),!b[0])return!1;if(1==b.length||IX.isEmpty(b[1]))b[1]="00";else if(b[1]=o(b[1],0,59,!0),!b[1])return!1;if(2==b.length||IX.isEmpty(b[2]))b[2]="00";else if(b[2]=o(b[2],0,59,!0),!b[2])return!1;return b.join(":")}function q(a){var b=a.split(".");if(4!=b.length)return!1;for(var c=0;4>c;c++){if(!o(b[c],0,255))return!1;b[c]=b[c]-0}return b.join(".")}function r(a){return o(a,0,65535,!1)?a:!1}function s(a){return o(a,0,999999,!1)?a:!1}function t(){IX.iterate(["control-time","schedule-time","ntp-ip","ntp-port"],function(a){var b=$X(a);IX.bind(b,{keydown:function(a){13==a.which&&(a.preventDefault(),b.blur())},blur:function(){N[a](b)}})})}function u(a){v("getConfig",{},function(b){L=b,$X("body").innerHTML=K.renderData("",n()),t(),jQuery(".cursor").find("input").attr("disabled",!0),a()})}var v=TCM.Global.sysCaller,w=IXW.Actions.configActions,x=TCM.LineInfo,y=TCM.Lib.Grid,z=TCM.SysDialog,A=NV.Dialog.alert,B=IXW.Lib.info,C=null,D=null,E=null,F={line:{container:"sysline-grid",title:"线路和车站管理",clz:"sys-line",hasCheckbox:!0,columns:"siteNo,name,siteType,desc",buttons:["create","delete"],dataLoader:function(a,c){v("getLineInfo",{},function(a){var d=b(a);c({total:d.length,items:d})})}},role:{title:"角色管理",clz:"sys-role",hasCheckbox:!0,columns:"roleName,roleType,rolePromptable",buttons:["create","delete"],dataLoader:function(a,b){v("getUserRole",{},function(a){var c=x.getRoles();c.refresh(a.items),b(a)})}},level:{title:"用户优先级定义",clz:"sys-level",columns:"levelName,station,depot",buttons:[],dataLoader:function(a,b){v("getUserLevel",{},function(a){var c=x.getLevels();c.refresh(a.items),b(a)})}},user:{title:"用户管理",clz:"sys-user",hasCheckbox:!0,usePagination:!0,columns:"userName,account,utype,userSite,userRole,desc",buttons:["create","delete"],dataLoader:function(a,b){v("getUsers",a,function(a){b(a),jQuery("ul[data-id="+TCM.Env.getSession().getUserId()+"]").find("a.act-delete").hide()})}}},G=new IX.ITemplate({tpl:['<div class="l icon">','<div class="pic-"></div><div>线路信息</div>',"</div>",'<div class="l text">',"<div>",'<span class="label">线路名称：</span>','<input id="lineName" disabled="true" value="{value}">',"</div>","<div>",'<span class="label">当前单位：</span>','<input class="siteName" disabled="true" value="{currentSiteName}">','<a class="setSite" data-href="$sys.setCurrentSite"></a>',"</div>	","</div>",""]}),H=new IX.ITemplate({tpl:['<div class="sys-info"></div>','<div id="sysline-grid"></div>',""]}),I=null,J=null;w([["sys.setCurrentSite",function(a,b){var c=TCM.LineInfo.getSites().getAll();TCM.SysDialog.setCurrentSite(a,b,c)}]]);var K=new IX.ITemplate({tpl:['<div class="nv-box sys-config">','<div class="nv-title">系统设置</div>','<div class="nv-body">','<div class="area">',"<h3>数据配置同步设置</h3>",'<div class="item"> ','<a data-href="$sys.syncData" class="btn-syncData"></a>',"</div>",'<div class="item"> ','<a data-href="$sys.check" data-key="Sync" class="nv-checkbox {syncClz}">','<span class="ixpic-"></span><span>{syncTxt}</span>',"</a>","</div>","</div>",'<div class="{cursor}">','<div class="area">',"<h3>控制释放延时设置</h3>",'<div class="item"> ',"<span>控制释放延时：</span>",'<span><input maxlength="6" id="control-time" value="{controlTime}" {controlTimeAttr}/></span>',"<span>毫秒</span>","</div> ","</div>",'<div class="area">',"<h3>系统校时设置</h3>",'<div class="item sum">','<h6 class="display">校时方式选择</h6>','<div class="display">','<a data-href="$sys.checkRS422" class="nv-radio rs422 {rs422Clz}">','<span class="ixpic- {radioSite}"></span><span>启用RS－422方式</span>',"</a>","</div>","<div>",'<a data-href="$sys.checkNTP" class="nv-radio ntp {ntpClz}">','<span style="display: none" class="ixpic- {radioSite}"></span><span>NTP服务器</span>',"</a>",'<span><input id="ntp-ip" value="{ntpIP}" {hostAttr}/></span>',"<span>端口</span>",'<span><input id="ntp-port" value="{ntpPort}" {portAttr}/></span>',"</div>","</div>",'<div class="line"></div>','<div class="item {dispayView}"> ','<a data-href="$sys.syncTiming" class="btn-syncTiming"></a>','<span class="syncTiming-mask hide"></span>',"</div>",'<div class="item">','<a data-href="$sys.checkTiming" class="nv-checkbox {timingClz}">','<span class="checkTime ixpic- {checkSite}"></span><span>启用自动校时</span>',"</a>",'<span class="schedule-time"><b>每天</b>','<input id="schedule-time" value="{scheduleTime}" {scheduleAttr}/></span>',"<span>时进行同步</span>","</div>","</div>",'<div class="area">',"<h3>服务器备份设置</h3>",'<div class="item"> ','<a class="nv-checkbox {tvsClz}">','<span class="ixpic- {dispayInView}"></span><span>启用视频服务器异地备份功能</span>',"</a>",'<a data-href="$sys.check" data-key="ServerBackupSetting.backupTVS" class="button {dispayView} {tvsClz}"></a>',"</div>",'<div class="item">','<a class="nv-checkbox {ssClz}">','<span class="ixpic- {dispayInView}"></span><span>启用存储服务器异地备份功能</span>',"</a>",'<a data-href="$sys.check" data-key="ServerBackupSetting.backupSS" class="button {dispayView} {ssClz}"></a>',"</div>","</div>",'<div class="area">',"<h3>存储备份设置</h3>",'<div class="item"> ','<a class="nv-checkbox {storageClz}">','<span class="ixpic- {dispayInView}"></span><span>启用存储异地备份功能</span>',"</a>",'<a data-href="$sys.check" data-key="StorageBackupSetting" class="button storage {dispayView} {storageClz}"></a>',"</div>	","</div>","</div>	","</div>","</div>		",""]
}),L={},M={1:"修改控制中心配置数据时，立即向控制中心TVS和下属各车站／车辆段发送配置数据",2:"修改本车辆段配置数据时，立即向控制中心和本车辆段TVS发送配置数据",3:"修改本车站配置数据时，立即向控制中心和本车站TVS发送配置数据"};w([["sys.check",function(a,b){function c(){if("ServerBackupSetting.backupSS"==a.key||"ServerBackupSetting.backupTVS"==a.key){var c=JSON.parse($XP(L,"ServerBackupSetting"));"ServerBackupSetting.backupSS"==a.key&&(c.backupSS=d),"ServerBackupSetting.backupTVS"==a.key&&(c.backupTVS=d),L.ServerBackupSetting=JSON.stringify(c)}else IX.setProperty(L,a.key,d);$XH[d?"addClass":"removeClass"](b,"selected"),j(),NV.Dialog.hide()}if(E||"Sync"==a.key){var d=!$XH.hasClass(b,"selected");return d||"Sync"==a.key?void c():NV.Dialog.confirm("备份设置","停止异地备份功能可能导致紧急情况下备份数据丢失，请慎重！",c)}}],["sys.syncData",function(a,b){v("syncData",{},function(){B("服务器已向TVS以及其它服务器发送相关配置数据！")})}],["sys.syncTiming",function(a,b){E&&v("syncTiming",{},function(){B("服务器已向TVS发出立即同步时钟命令！")})}],["sys.checkTiming",function(a,b){if(E){var c=!$XH.hasClass(b,"selected"),d=$XH.hasClass(jQuery(".rs422").get(0),"selected"),e=$XH.hasClass(jQuery(".ntp").get(0),"selected"),f=(jQuery("#schedule-time").attr("value"),jQuery("#ntp-ip").attr("value")),g=jQuery("#ntp-port").attr("value");$XH[c?"addClass":"removeClass"](b,"selected"),L.TimingSetting=JSON.stringify({schedule:"01:00:00",useRS422:d,useNTP:e,ntpIP:f,ntpPort:g,autoTiming:c?!0:!1}),c?jQuery("#schedule-time").attr("disabled",!1):jQuery("#schedule-time").attr("disabled",!0),k()}}],["sys.checkRS422",function(a,b){var c=JSON.parse($XP(L,"TimingSetting"));if(E){var d=$XH.ancestor(b,"area");$XH.hasClass(b,"selected")||(jQuery(d).find(".rs422").addClass("selected"),jQuery(d).find(".ntp").removeClass("selected"),jQuery(".sum").find("input").attr("disabled",!0),c.useRS422=!0,c.useNTP=!1,L.TimingSetting=JSON.stringify(c),k())}}],["sys.checkNTP",function(a,b){var c=JSON.parse($XP(L,"TimingSetting"));if(E){var d=$XH.ancestor(b,"area");$XH.hasClass(b,"selected")||(jQuery(d).find(".rs422").removeClass("selected"),jQuery(d).find(".ntp").addClass("selected"),jQuery(".sum").find("input").removeAttr("disabled"),c.useRS422=!1,c.useNTP=!0,L.TimingSetting=JSON.stringify(c),k())}}]]);var N={"control-time":function(a){var b=a.value;if(b!=L.ControlReleaseTime){var c=s(b);if(!c)return A("请输入有效的控制释放延时时间！");L.ControlReleaseTime=b-0,a.value=c,j()}},"schedule-time":function(a){var b=a.value,c=JSON.parse($XP(L,"TimingSetting"));if(b!=c.schedule){var d=p(b);if(!d)return A("请输入正确的时间格式，例如：01:00:00");c.schedule=d,L.TimingSetting=JSON.stringify(c),a.value=d,k()}},"ntp-ip":function(a){var b=a.value,c=JSON.parse($XP(L,"TimingSetting"));if(b!=c.ntpIP){var d=q(b);if(!d)return A("请输入正确的NTP地址，例如：192.168.0.1");c.ntpIP=d,L.TimingSetting=JSON.stringify(c),a.value=d,c.ntpPort?k():jQuery("#ntp-port").focus()}},"ntp-port":function(a){var b=a.value,c=JSON.parse($XP(L,"TimingSetting"));if(b!=c.ntpPort){var d=r(b);if(!d)return A("请输入正确的NTP端口，端口号范围：0~65535");c.ntpPort=d,L.TimingSetting=JSON.stringify(c),a.value=d,c.ntpIP?k():jQuery("#ntp-ip").focus()}}};IX.ns("TCM.Sys"),TCM.Sys.init=function(a,b,c){switch(C=TCM.Env.getSession(),a.name){case"sys-line":e(c);break;case"sys-role":f(c);break;case"sys-level":g(c);break;case"sys-user":i(c);break;case"sys-config":u(c)}}}(),function(){function a(a,b){return'<span><input disabled class="'+a+'" value="'+R[b]+'"><input type="hidden" id="'+a+'" value="'+b+'"></span>'}function b(a){var b=/^([0-9]|[1-9]\d|[1-9]\d{2}|[1-9]\d{3}|[1-5]\d{4}|6[0-4]\d{3}|65[0-4]\d{2}|655[0-2]\d|6553[0-5])$/;return b.test(a)}function c(a){var b=/^(?!(0[0-9]{0,}$))[0-9]{1,}[.]{0,}[0-9]{0,}$/;return b.test(a)}function d(a){var b=/^[1-9]\d*$/;return b.test(a)}function e(a){var b=/^(2(2[4-9]|3[0-9]))\.([0-9]|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.([0-9]|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.([0-9]|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])$/;return b.test(a)}function f(a){return a.isIP()}function g(a){return a.isWindowsDirectory()}function h(a,b){var c=ma[a];return c&&!c.fn(b)?(O(c.text),!1):!0}function i(a,b,c){return"undefined"==a||"null"==a?(O(b+"为字符非法,请重新输入！"),!1):a.toString().trim()||IX.isEmpty(b)?h(c,a):(O(b+"不能为空!"),!1)}function j(a,b,c,d){var e='.tree-node[data-siteid="'+c+'"]',f=d?e+'[data-zoneid="'+d+'"]':e;jQuery(f).each(function(){var c=jQuery(this).attr("data-key").split(",");if(IX.Array.isFound(a,c)){var d=jQuery(this).children("span").find(".count"),e=d.html();e=e.substring(1,e.length-1)-0+b,d.html("("+e+")")}})}function k(a,b,c,d){Array.isArray(a)?IX.iterate(a,function(a){j(a,b,c,d)}):j(a,b,c,d)}function l(a,b,c,d,e){function f(a,e,f){N(b.title,W.renderData("",{count:g+b.unitName}),function(g){J(b.callerName,a,function(a){g(),c(),k(e,-1,d,f)})})}var g=a.length,h=[],i=IX.map(a,function(a){return h.push(a.get("type")),a.getId()});e?f({id:e,cameras:i},h,e):f({ids:i},h)}function m(a){for(var c=[],d=0;a>d;d++){var f=$X("device_bcAddr"+(d+1)).value,g=$X("device_bcPort"+(d+1)).value;if(!e(f))return O("通道"+(d+1)+"的组播流地址，范围：224.0.0.0~239.255.255.255"),!1;if(!b(g))return O("通道"+(d+1)+"的端口号错误！"),!1;c.push({addr:f,channelNo:d+1,port:g-0})}return c}function n(a,b,c){for(var d={},e=!1,f=0;f<b.length;f++){var g=b[f],h=null;if("device_relatedDecoders"==g.key){if(IX.Array.isFound(null,oa))return O("关联解码器不能为空！");h=IX.map(oa,function(a){return a.id})}else{if("device_bc"==g.key)continue;if(IX.Array.isFound(d.type,[31,32])&&"device_driverId"==g.key)continue;h=$X(g.key).value}if(!i(h,g.empty,g.name))return!1;e=e||!(a&&a.get(g.name)==h),IX.setProperty(d,g.name,h)}if(d.type==Q.Coder){d.channelNum=d.channelNum-0;var j=m(d.channelNum);if(!j)return;a&&(e=e||JSON.stringify(j)!==JSON.stringify(a.get("bc"))),d.bc=JSON.stringify(j)}return e?(a?d.id=a.getId():delete d.id,d):(P("您未作任何修改，请点击取消关闭编辑窗口！"),!1)}function o(a,b,c,d,e){function f(){var f=n(a,g,d);if(f)return d[0]!==Q.RedirectPickup||d[1]!==Q.OmnidirectPickup||f.relatedCamera?void J(b.callerName,f,function(b){return M(),c({ids:[0===f.id?f.id:f.id||b.id]}),a?void(IX.Array.isFound(d[0],ja.concat(ka))&&d[0]!=f.type&&(k(d[0],-1,e),k(f.type,1,e))):k(f.type,1,e)}):O("拾音器关联的摄像机不能为空！")}var g=b.checkers;IX.Array.isFound(Q.PDU,d)&&d.length<7&&(g=g.concat([{name:"username",key:"device_username",empty:""},{name:"password",key:"device_password",empty:""}]));for(var h={},i=0;i<g.length;i++){var j=g[i],l=null;a&&(l=a.get(j.name)),h[j.key]=l||0===l?l.toString().dehtml():"","device_relatedDecoders"==j.key&&(h[j.key]=l||[]),"device_bc"==j.key&&(h[j.key]=l||"")}a||(h.device_username||(h.device_username="admin"),h.device_password||(h.device_password="admin"),IX.Array.isFound(d[0],ja.concat(Q.Decoder))&&(h.device_channelNum="1"),h.device_type=d[0]);var m=b.tpldataFn(a,h);return 0===m.driverCombo?O("该设备类型未定义驱动,无法执行相关操作！"):!m&&IX.Array.isFound(d[0],ka)?O("请添加编码器后，再添加模拟摄像机！"):void L({clz:b.clz,title:b.title,content:b.tpl.renderData("",m),listen:{ok:f}})}function p(a,b,c,d){var e=IX.Array.isFound(b,la);return S(a,{value:b,valueText:R[b],items:IX.map(c,function(a){return IX.inherit({id:a,name:R[a]},e?{action:"PUB.changeType"}:{})})},d)}function q(a,b,c,d){return S(a,{value:b,valueText:c,items:d})}function r(a,b,c){var d=null;return IX.iterate(c,function(a,c){a.id==b&&(d=a.name),a.action="pick.coder"}),S(a,{value:b,valueText:d,items:c})}function s(a){return IX.map(a,function(a,b){return{id:a.channelNo,name:a.channelNo,clz:a.used?"coder-disabled":"coder-usable",action:"pick.channelNo"}})}function t(a){return IX.map(a,function(a,b){return a.action="decoder.pick",a})}function u(a,b,c,d){return S(a,{value:b,valueText:b,items:IX.map(c,function(a){return{id:a,name:a,action:d}})})}function v(a,b,c){var d=IX.Array.isFound(b,ja);return S(a,{value:b,valueText:R[b],items:IX.map(c,function(a){return{id:a,clz:"",name:R[a],action:d?"IPC.changeType":"camera.changeType"}})})}function w(a,b,c){var d,e=TCM.Device.getDriver4Type(b);return e?(c&&(d=TCM.Device.getDriver(c).provider+"-"+TCM.Device.getDriver(c).style),S(a,{value:c?c:e[0].id,valueText:c?d:e[0].provider,items:IX.map(e,function(a,b){return IX.inherit(a,{name:a.provider,action:"driver.pick"})})},"driver.pick")):0}function x(a,b,c){for(var d=null,e=0;e<c.length;e++)c[e].id==b&&"0"!=c[e].id&&(d=c[e].name);return S(a,{value:b,valueText:d,items:IX.map(c,function(a){return{id:a.id,name:a.name}})})}function y(a,b){return a===Q.Spliter?J("getAllNotRelatedDecoders",{
type:a},function(a){b(a)}):IX.Array.isFound(a,[Q.RedirectPickup,Q.OmnidirectPickup,Q.VDM])?J("getAllNotRelatedCameras",{type:a},function(a){b(a)}):IX.Array.isFound(a,ja)?J("getAllZones",{},function(a){b(a[0].zones)}):IX.Array.isFound(a,ka)?J("getAllZones",{},function(a){J("getAllCoders",{},function(c){pa={},IX.iterate(c,function(a,b){pa[a.id]=a}),b({zones:a[0].zones,coders:c})})}):void b()}function z(a,b,c){var d=$XH.ancestor(c,"dropdown");if(d){var e=$XD.first(d,"input");e.value=a;var f=$XH.first($XH.first(d,"dropdown-toggle"),"name");f.innerHTML=b}}function A(){jQuery(".loopDecoder .dropdown-menu").each(function(){jQuery(this).html(IX.loop(t(na),"",function(a,b,c){return a+=ia.renderData("",b)}))})}function B(a,b,c){jQuery("#device_username").val(a),jQuery("#device_password").val(b),jQuery("#device_port").val(c)}function C(a){var b=[{name:"name",key:"device_name",empty:"设备名称"},{name:"type",key:"device_type",empty:""},{name:"desc",key:"device_desc",empty:""}];return b.concat(a)}function D(a,b){for(var c=0;c<a.length;c++)if(b==a[c].id)return a[c].name;return""}function E(b,c,d,e){return b||0!==e.coders.length?(c.zoneIdCombo=x("zone_id",c.zone_id||"",e.zones?e.zones:[]),c.bitsets=u("device_bitsets",c.device_bitsets||sa[0],sa),c.clz=33==(c.device_type||d[0])?"cameraSphere":"camera-edit",b||1!==d.length?c.camerasTypeCombo=v("device_type",c.device_type||d[0],[31,32,33]):c.camerasTypeCombo=a("device_type",c.device_type||d[0]),c.coderCombo=r("coder_id",c.coder_id||"",e.coders),c.channelNoCombo=S("channel_no",{value:c.channel_no||"",valueText:c.channel_no||"",items:c.coder_id?s(pa[c.coder_id].channels):[]}),33==d[0]&&(c.driverCombo=w("device_driverId",33,c.device_driverId)),c):!1}function F(a,b,c,d){var e=b.device_relatedCamera&&a?[{id:b.device_relatedCamera,name:a.get("relatedCameraName")}]:[];b.deviceRelated=q("device_relatedCamera",b.device_relatedCamera||"",a?a.get("relatedCameraName"):"",e.concat(d.notRelatedCameras||[])),b.zoneIdCombo=x("zone_id",b.zone_id||"",d?d:[]);var f=D(ua,b.device_parityBit||0),g=D(wa,b.device_stopBit||0),h=D(va,b.device_commPort||0);b.maxWindowCombo=u("device_maxWindow",b.device_maxWindow||qa[0],qa,"device.changeMaxWindow"),52==c[0]&&(b.baudRateCombo=u("device_baudRate",b.device_baudRate||sa[8],sa)),65==c[0]&&(b.baudRateCombo=u("device_baudRate",b.device_baudRate||sa[1],sa)),b.dataBitCombo=u("device_dataBit",b.device_dataBit||ta[4],ta),b.parityCombo=q("device_parityBit",b.device_parityBit||0,f,ua),b.stopBitCombo=q("device_stopBit",b.device_stopBit||0,g,wa),b.commPortCombo=q("device_commPort",b.device_commPort||0,h,va),oa=[null],na=d.notRelatedDecoders||[],b.relatedDecoders=[{i:1,relatedDecoders:q("device_relatedDecoders1","","",t(na))}],oa=b.device_maxWindow?new Array(Number(b.device_maxWindow)):[null],na=d.notRelatedDecoders||[];for(var i=0;i<oa.length;i++)oa[i]=null;return b.relatedDecoders=IX.loop("0".multi(oa.length).split(""),[],function(a,c,d){var e={};return e.i=d+1,oa[d]=b.device_relatedDecoders?b.device_relatedDecoders[d]:"",e.relatedDecoders=q("device_relatedDecoders"+(d+1),oa[d]?oa[d].id:"",oa[d]?oa[d].name:"",t(na)),a.push(e),a}),b}function G(b,c,d,e){if(IX.Array.isFound(d[0],ka))return E(b,c,d,e);e&&(c=F(b,c,d,e)),c.channelNums=u("device_channelNum",c.device_channelNum||1,ra,"device.changeChannel"),c.channels=c.device_bc?c.device_bc:[{addr:"",port:"",channelNo:1}],c.channelNum='<span><input disabled id="device_channelNum" value="1"></span>';var f=c.device_type||d[0];return b?c.deviceTypeCombo=a("device_type",f):c.deviceTypeCombo=p("device_type",f,d,"relatedCamera.pick"),c.camerasTypeCombo=v("device_type",f,[20,21,22]),b||1!==d.length||(c.camerasTypeCombo=a("device_type",f),c.deviceTypeCombo=a("device_type",f)),c.cameraId='<input type="hidden" id="device_id" value="'+c.device_id+'">',c.clz=64==f?"PDU-edit":"edit",IX.Array.isFound(f,[10,50,51,52,55,65])&&(c.driverCombo=w("device_driverId",f,c.device_driverId)),IX.Array.isFound(f,[20,21,22])&&(c.driverCombo=w("device_driverId",202122,c.device_driverId)),c}function H(a,b){var c=za.renderData("",{siteId:b.id,zoneId:a.id,zoneName:IX.encodeTXT(a.name),fixed:a.total.fixed,items:[{type1:20,type2:31,siteId:b.id,zoneId:a.id,name:"枪机",count:a.total.fixed},{type1:21,type2:32,siteId:b.id,zoneId:a.id,name:"半球",count:a.total.semi},{type1:22,type2:33,siteId:b.id,zoneId:a.id,name:"球机",count:a.total.sphere}]}),d=jQuery(".nv-tree>ul>li");d.hasClass("none")&&d.removeClass("none").addClass("expand");var e=jQuery(".nv-tree ul")[1];e||(e=jQuery("<ul></ul>"),d.append(e)),jQuery(e).append(jQuery(c)),jQuery(e).children("li").last().children("a").find(".count").click()}function I(a,b){var c=jQuery(".nv-tree [data-zoneid="+a+"]"),d=b.fixed+b.semi+b.sphere,e=[],f=0;e=e.concat(d,b.fixed,b.semi,b.sphere),c.each(function(){jQuery(this).find(".count").html("("+e[f++]+")")})}var J=TCM.Global.deviceAndZoneCaller,K=IXW.Actions.configActions,L=NV.Dialog.show,M=NV.Dialog.hide,N=NV.Dialog.confirm,O=NV.Dialog.alert,P=IXW.Lib.info,Q=TCM.Const.DeviceTypes,R=TCM.Const.DeviceTypeNames,S=NV.Lib.getComboHTML,T=TCM.Lib.CameraTree,U=(NV.Lib.getCheckboxHTML,TCM.DeviceType.getNodeName),V=TCM.Const.DriverList,W=new IX.ITemplate({tpl:['<div class="hint">确认要删除这{count}吗？</div>',""]}),X=new IX.ITemplate({tpl:['<ul class="{clz}">','<li><span class="label">设备名称</span>','<span><input maxlength="64" id="device_name" value="{device_name}" tabindex="1"></span></li>','<li><span class="label">设备类型</span>{deviceTypeCombo}</li>','<li><span class="label">IP地址</span>','<span><input maxlength="15" id="device_ip" value="{device_ip}" tabindex="2"></span></li>','<li style="display:none;"><span class="label">端口号</span>','<span><input maxlength="5" id="device_port" value="1"></span></li>','<li><span class="label">软件版本号</span>','<span><input maxlength="64" id="device_version" value="{device_version}" tabindex="3"></span></li>','<li><span class="label">备注</span>','<span><input maxlength="150" id="device_desc" value="{device_desc}" tabindex="4"></span></li>',"</ul>",""]}),Y=new IX.ITemplate({tpl:['<ul class="{clz}">','<li><span class="label">设备名称</span>','<span><input maxlength="64" id="device_name" value="{device_name}" tabindex="1"></span>','<span class="label labelTwo">用户名</span>','<span><input maxlength="15" id="device_username" value="{device_username}" tabindex="5"></span></li>','<li><span class="label">数据口IP</span>','<span><input maxlength="15" id="device_dataIp" value="{device_dataIp}" tabindex="2"></span>','<span class="label labelTwo">密码</span>','<span><input maxlength="15" id="device_password" value="{device_password}" tabindex="6"></span></li>','<li><span class="label">管理口IP</span>','<span><input maxlength="15" id="device_manageIp" value="{device_manageIp}" tabindex="3"></span>','<span class="label labelTwo">硬盘数量</span>','<span><input maxlength="8" id="device_diskNum" value="{device_diskNum}" tabindex="7"><span class="unit-diskNum"></span></li>','<li><span class="label">端口号</span>','<span><input maxlength="5" id="device_port" value="{device_port}" tabindex="3"></span>','<span class="label labelTwo">总容量</span>','<span><input maxlength="8" id="device_capacity" value="{device_capacity}" tabindex="8"><span class="unit-capacity"></span></span></li>','<li><span class="label">厂家及型号</span>{driverCombo}','<span class="label labelTwo">备注</span>','<span><input maxlength="150" id="device_desc" value="{device_desc}" tabindex="9"></span>','<input id="device_type" value="{device_type}" style="display: none;"></li>',"</ul>",""]}),Z=new IX.ITemplate({tpl:['<ul class="{clz}">','<li><span class="label">设备名称</span>','<span><input maxlength="64" id="device_name" value="{device_name}" tabindex="1"></span></li>','<li><span class="label">设备类型</span>{deviceTypeCombo}</li>','<li><span class="label">厂家</span>','<span><input maxlength="30" id="device_provider" value="{device_provider}" tabindex="2"></span></li>','<li><span class="label">型号</span>','<span><input maxlength="30" id="device_style" value="{device_style}" tabindex="3"></span></li>','<li class="related-camera"><span class="label">关联的摄像机</span>{deviceRelated}</li>','<li><span class="label">备注</span>','<span><input maxlength="150" id="device_desc" value="{device_desc}" tabindex="4"></span></li>',"</ul>",""]
}),$=new IX.ITemplate({tpl:['<ul class="{clz}">','<li class="spliters"><span class="labelOne">设备名称</span>','<span><input maxlength="64" id="device_name" value="{device_name}" tabindex="1"></span></li>','<li class="spliters"><span class="labelOne">停止位</span>{stopBitCombo}</li>','<li class="spliters"><span class="labelOne">厂家及型号</span>{driverCombo}</li>','<li class="spliters"><span class="labelOne">校验位</span>{parityCombo}</li>','<li class="spliters"><span class="labelOne">串口号</span>{commPortCombo}</li>','<li class="spliters"><span class="labelOne">最大画面数</span>{maxWindowCombo}</li>','<li class="spliters"><span class="labelOne">波特率</span>{baudRateCombo}</li>','<li class="spliters"><span class="labelOne">备注</span>','<span><input maxlength="150" id="device_desc" value="{device_desc}" tabindex="2"></span></li>','<li class="spliters"><span class="labelOne">数据位</span>{dataBitCombo}</li>','<tpl id="relatedDecoders">','<li class="spliters loopDecoder"><span class="labelOne">通道{i}关联解码器</span>{relatedDecoders}',"</tpl>",'<input id="device_type" value="{device_type}" style="display: none;">',"</ul>",""]}),_=new IX.ITemplate({tpl:['<ul class="{clz}">','<li><span class="label">设备名称</span>','<span><input maxlength="64" id="device_name" value="{device_name}" tabindex="1"></span>','<span class="label labelTwo">停止位</span>{stopBitCombo}</li>','<li><span class="label">厂家及型号</span>{driverCombo}','<span class="label labelTwo">校验位</span>{parityCombo}</li>','<li><span class="label">串口号</span>{commPortCombo}','<span class="label labelTwo">关联的摄像机</span>{deviceRelated}</li>','<li><span class="label">波特率</span>{baudRateCombo}','<span class="label labelTwo">备注</span>','<span><input maxlength="150" id="device_desc" value="{device_desc}" tabindex="2"></span></li>','<li><span class="label">数据位</span>{dataBitCombo}</li>','<input id="device_type" value="{device_type}" style="display: none;">',"</ul>",""]}),aa=new IX.ITemplate({tpl:['<ul class="{clz}">','<li><span class="label">设备名称</span>','<span><input maxlength="64" id="device_name" value="{device_name}"></span></li>','<li><span class="label">IP地址</span>','<span><input maxlength="15" id="device_ip" value="{device_ip}"></span></li>','<li><span class="label">备注</span>','<span><input maxlength="150" id="device_desc" value="{device_desc}"></span></li>','<input id="device_type" value="{device_type}" style="display: none;">',"</ul>",""]}),ba=new IX.ITemplate({tpl:['<ul class="{clz}">','<li><span class="label">设备名称</span>','<span><input maxlength="64" id="device_name" value="{device_name}" tabindex="1"></span></li>','<li><span class="label">设备类型</span>{deviceTypeCombo}</li>','<li><span class="label">厂家</span>','<span><input maxlength="30" id="device_provider" value="{device_provider}" tabindex="2"></span></li>','<li><span class="label">型号</span>','<span><input maxlength="30" id="device_style" value="{device_style}" tabindex="3"></span></li>','<li><span class="label">软件名称或网页地址</span>','<span><input maxlength="64" id="device_path" value="{device_path}" tabindex="4"></span></li>','<li class="pdu"><span class="label">用户名</span>','<span><input maxlength="15" id="device_username" value="{device_username}" tabindex="5"></span></li>','<li class="pdu"><span class="label">密码</span>','<span><input maxlength="15" id="device_password" value="{device_password}" tabindex="6"></span></li>','<li><span class="label">备注</span>','<span><input maxlength="150" id="device_desc" value="{device_desc}" tabindex="7"></span></li>',"</ul>",""]}),ca=new IX.ITemplate({tpl:['<ul class="{clz}">','<li><span class="label">设备名称</span>','<span><input maxlength="64" id="device_name" value="{device_name}" tabindex="1"></span>','<span class="label labelTwo">用户名</span>','<span><input maxlength="15" id="device_username" value="{device_username}" tabindex="4"></span></li>','<li><span class="label">IP地址</span>','<span><input maxlength="15" id="device_ip" value="{device_ip}" tabindex="2"></span>','<span class="label labelTwo">密码</span>','<span><input maxlength="15" id="device_password" value="{device_password}" tabindex="5"></span></li>','<li><span class="label">端口号</span>','<span><input maxlength="5" id="device_port" value="{device_port}" tabindex="3"></span>','<span class="label labelTwo">通道数</span>','<span><input maxlength="4" id="device_channelNum" value="{device_channelNum}" tabindex="6"></span></li>','<li><span class="label">厂家及型号</span>{driverCombo}','<span class="label labelTwo">备注</span>','<span><input maxlength="150" id="device_desc" value="{device_desc}" tabindex="7"></span></li>','<input id="device_type" value="{device_type}" style="display: none;">',"</ul>",""]}),da=new IX.ITemplate({tpl:['<ul class="{clz}">','<li><span class="label">设备名称</span>','<span><input maxlength="64" id="device_name" value="{device_name}" tabindex="1"></span>','<span class="label labelTwo">用户名</span>','<span><input maxlength="15" id="device_username" value="{device_username}" tabindex="4"></span></li>','<li><span class="label">IP地址</span>','<span><input maxlength="15" id="device_ip" value="{device_ip}" tabindex="2"></span>','<span class="label labelTwo">密码</span>','<span><input maxlength="15" id="device_password" value="{device_password}" tabindex="5"></span></li>','<li><span class="label">端口号</span>','<span><input maxlength="5" id="device_port" value="{device_port}" tabindex="3"></span>','<span class="label labelTwo">通道数</span>','<span><input maxlength="4" id="device_channelNum" value="{device_channelNum}" tabindex="6"></span></li>','<li><span class="label">厂家及型号</span>{driverCombo}','<span class="label labelTwo">最大画面数</span>','<span><input maxlength="4" id="device_maxWindow" value="{device_maxWindow}" tabindex="7"></span></li>','<li><span class="label">备注</span>','<span><input maxlength="150" id="device_desc" value="{device_desc}" tabindex="8"></span></li>','<input id="device_type" value="{device_type}" style="display: none;">',"</ul>",""]}),ea=new IX.ITemplate({tpl:['<ul class="{clz}">','<li><span class="label">设备名称</span>','<span><input maxlength="64" id="device_name" value="{device_name}"></span></li>','<li><span class="label">厂家</span>','<span><input maxlength="30" id="device_provider" value="{device_provider}"></span></li>','<li><span class="label">型号</span>','<span><input maxlength="30" id="device_style" value="{device_style}"></span></li>','<li><span class="label">备注</span>','<span><input maxlength="150" id="device_desc" value="{device_desc}"></span></li>','<input id="device_type" value="{device_type}" style="display: none;">',"</ul>",""]}),fa=new IX.ITemplate({tpl:['<ul class="{clz} main">','<li><span class="label">设备名称</span>','<span><input maxlength="64" id="device_name" value="{device_name}" tabindex="1"></span>','<span class="label labelTwo">用户名</span>','<span><input maxlength="15" id="device_username" value="{device_username}" tabindex="4"></span></li>','<li><span class="label">IP地址</span>','<span><input maxlength="15" id="device_ip" value="{device_ip}" tabindex="2"></span>','<span class="label labelTwo">密码</span>','<span><input maxlength="15" id="device_password" value="{device_password}" tabindex="5"></span></li>','<li><span class="label">端口号</span>','<span><input maxlength="5" id="device_port" value="{device_port}" tabindex="3"></span>','<span class="label labelTwo">厂家及型号</span>{driverCombo}</li>','<li><span class="label">通道数</span>{channelNums}','<span class="label labelTwo">备注</span>','<span><input maxlength="150" id="device_desc" value="{device_desc}" tabindex="7"></span></li>','<input id="device_type" value="{device_type}" style="display: none;">','<li class="last"><span class="title">通道设置</span>',"</ul>",'<ul id="bcList" class="sub"></li>','<tpl id="channels">','<li><span class="label">通道{channelNo}组播地址</span><span><input maxlength="64" id="device_bcAddr{channelNo}" value="{addr}"></span><span class="label labelTwo">通道{channelNo}组播端口</span><span><input maxlength="64" id="device_bcPort{channelNo}" value="{port}"></span></li>',"</tpl>","</ul>",""]}),ga=new IX.ITemplate({tpl:['<ul class="{clz}">','<li><span class="label">设备名称</span>','<span><input maxlength="64" id="device_name" value="{device_name}" tabindex="1"></span>','<span class="label labelTwo">用户名</span>','<span><input maxlength="15" id="device_username" value="{device_username}" tabindex="6"></span></li>','<li><span class="label">IP地址</span>','<span><input maxlength="15" id="device_ip" value="{device_ip}" tabindex="2"></span>','<span class="label labelTwo">密码</span>','<span><input maxlength="15" id="device_password" value="{device_password}" tabindex="7"></span></li>','<li><span class="label">端口号</span>','<span><input maxlength="5" id="device_port" value="{device_port}" tabindex="3"></span>','<span class="label labelTwo">摄像机类型</span>{camerasTypeCombo}</li>','<li class="camera-style"><span class="label">组播流地址</span>','<span><input maxlength="15" id="device_bcAddr" value="{device_bcAddr}" tabindex="4"></span>','<span class="label labelTwo">厂家及型号</span>{driverCombo}</li>','<li><span class="label">组播流端口</span>','<span><input maxlength="5" id="device_bcPort" value="{device_bcPort}" tabindex="5"></span>','<span class="label labelTwo">所属分区</span>{zoneIdCombo}</li>','<li><span class="label">通道数</span>{channelNum}','<span class="label labelTwo">备注</span>','<span><input maxlength="150" id="device_desc" value="{device_desc}" tabindex="9">{cameraId}</span></li>',"</ul>",""]
}),ha=new IX.ITemplate({tpl:['<ul class="{clz}">','<li><span class="label">设备名称</span>','<span><input maxlength="64" id="device_name" value="{device_name}"></span>','<span class="label labelTwo">设备类型</span>{camerasTypeCombo}</li>','<li><span class="label">关联编码器</span>{coderCombo}','<span class="label labelTwo">所属分区</span>{zoneIdCombo}</li>','<li class="related-channelNo"><span class="label">关联编码器的通道号</span>{channelNoCombo}</li>','<li class="desc"><span class="label labelTwo">备注</span>','<span><input maxlength="150" id="device_desc" value="{device_desc}"></span></li>','<li class="type33"><span>球机设置</span></li>','<li class="type33">','<ul class="sub"><li><span class="label">云台波特率</span>{bitsets}','<span class="label labelTwo">拨码地址</span>','<span><input maxlength="64" id="device_controlParams" value="{device_controlParams}"></span></li>','<li class="control-protocol"><span class="label">控制协议</span>{driverCombo}</li></ul>',"</li>","</ul>",""]}),ia=new IX.ITemplate({tpl:['<li><a data-href="${action}" data-key="{id}">{name}</a></li>',""]}),ja=[Q.IPCFixed,Q.IPCSemiSphere,Q.IPCSphere],ka=[Q.CameraFixed,Q.CameraSemiSphere,Q.CameraSphere],la=[Q.HUB,Q.PDH,Q.FiberConvertor,Q.KVM,Q.PDU,Q.Other],ma={name:{fn:g,text:'设备名称中请勿包含\\/^:*><|@?"特殊字符！'},ip:{fn:f,text:"请输入正确的IP地址，例如：192.168.0.1"},dataIp:{fn:f,text:"请输入正确的IP地址，例如：192.168.0.1"},manageIp:{fn:f,text:"请输入正确的IP地址，例如：192.168.0.1"},bcAddr:{fn:e,text:"请输入正确的组播流地址，范围：224.0.0.0~239.255.255.255"},bcPort:{fn:b,text:"请输入正确的组播流端口，端口号范围：0~65535"},channelNum:{fn:d,text:"通道数须为大于0的整数！"},capacity:{fn:c,text:"总容量须为大于0的数字！"},diskNum:{fn:d,text:"磁盘数量须为大于0的整数！"},maxWindow:{fn:d,text:"画面数必须为大于0的整数！"},port:{fn:b,text:"请输入正确的端口号，端口号范围：0~65535"}};K([["pick.coder",function(a,b){var c=a.key,d=b.innerHTML,e=$X("coder_id").value,f=$X("channel_no").value;f&&e&&IX.iterate(pa[e].channels,function(a){a.channelNo==f&&(a.used=0)}),z(c,d,b);var g=S("channel_no",{value:"",valueText:"",items:s(pa[c].channels)}),h=jQuery(".related-channelNo");h.children("span:last").remove(),h.append(g)}],["pick.channelNo",function(a,b){if(!$XH.hasClass(b.parentNode,"coder-disabled")){var c=a.key,d=b.innerHTML,e=$X("channel_no").value;e&&jQuery(b).parents(".dropdown-menu").find('[data-key="'+e+'"]').parent().removeClass("coder-disabled").addClass("coder-usable"),jQuery(b).parent().removeClass("coder-usable").addClass("coder-disabled"),z(c,d,b)}}],["IPC.changeType",function(a,b){var c=a.key,d=b.innerHTML,e=$X("device_id").value;return e?void J("isRelatePickup",{id:e,type:c},function(a){return a.msg?NV.Lib.confirm({content:a.msg,okFn:function(){z(c,d,b)}}):void z(c,d,b)}):void z(c,d,b)}],["camera.changeType",function(a,b){var c=a.key,d=b.innerHTML,e=w("device_driverId",c);if(33==c&&0===e)return O("该设备类型未定义驱动,无法执行相关操作！");z(c,d,b);var f=$XD.ancestor($XH.ancestor(b,"dropdown"),"ul");f.className=33==c?"cameraSphere":"camera-edit",jQuery(".control-protocol").html('<span class="label">控制协议</span>'+e)}],["device.changeChannel",function(a,b){var c=Number(a.key),d=b.innerHTML,e=Number(jQuery("#device_channelNum_combo").children(".name").html());z(c,d,b);var f=jQuery("#bcList").children("li"),g=f.last(),h="";if(c>e){for(var i=0;c-e>i;i++)h+=fa.renderData("channels",{channelNo:e+i+1,port:"",addr:""});jQuery(h).insertAfter(g)}else for(var j=0;e-c>j;j++)jQuery("#bcList").children("li").last().remove()}],["device.changeMaxWindow",function(a,b){var c=Number(a.key),d=b.innerHTML,e=jQuery(".loopDecoder").length;z(c,d,b);var f="";if(c>e){for(var g=0;c-e>g;g++)f+=$.renderData("relatedDecoders",{i:e+g+1,relatedDecoders:q("device_relatedDecoders"+(e+g+1),"","",t(na))}),oa.push(null);jQuery(f).insertAfter(jQuery(".spliter-edit").find(".spliters").last())}else{for(var h=0;e-c>h;h++)na=na.concat(oa.splice(1,oa.length)),jQuery(".spliter-edit").find(".spliters").last().remove();A()}}],["decoder.pick",function(a,b){var c=a.key,d=b.innerHTML;z(c,d,b);var e=jQuery($XH.ancestor(b,"dropdown")).find("input").get(0).id,f=Number(e.slice(22,e.length)),g=null;IX.iterate(na,function(a,b){a.id==c&&(g=b)}),na.splice(g,1),oa[f-1]&&na.unshift(oa[f-1]),oa[f-1]={id:c,name:d},A()}],["relatedCamera.pick",function(a,b){var c=a.key,d=b.innerHTML,e=c!=$X("device_type").value;z(c,d,b),$X("device_relatedCamera")&&e&&J("getAllNotRelatedCameras",{type:c},function(a){jQuery(".related-camera").get(0).innerHTML='<span class="label">关联的摄像机</span>'+q("device_relatedCamera","","",a.notRelatedCameras)})}],["PUB.changeType",function(a,b){var c=a.key,d=b.innerHTML;z(c,d,b);var e=$XD.ancestor($XH.ancestor(b,"dropdown"),"ul");e.className=64==c?"PDU-edit":"edit"}],["driver.pick",function(a,b){var c=a.key,d=b.innerHTML;if(jQuery(".IPC-edit").length>0||jQuery(".coder-edit").length>0||jQuery(".decoder-edit").length>0)for(var e=TCM.Device.getDriver,f=0;f<V.length;f++){var g=e(c);g.name==V[f].name&&g.provider==V[f].provider&&g.style==V[f].style&&B(V[f].username,V[f].password,V[f].port)}var h=$XH.ancestor(b,"dropdown");if(h){var i=$XD.first(h,"input");i.value=c;var j=$XH.first($XH.first(h,"dropdown-toggle"),"name");j.innerHTML=d}}]]);var na=[],oa=[],pa={},qa=[1,2,4,9,16],ra=[1,2,4,8,16,32],sa=[4800,9600,16e3,19200,38400,43e3,56e3,57600,115200],ta=[4,5,6,7,8],ua=[{id:0,name:"无"},{id:1,name:"奇"},{id:2,name:"偶"},{id:3,name:"标记"},{id:4,name:"空格"}],va=IX.map("0".multi(8).split(""),function(a,b){return{id:b,name:"COM"+(b+1)}}),wa=[{id:0,name:"1"},{id:1,name:"1.5"},{id:2,name:"2"}],xa={0:{name:"ip",key:"device_ip",empty:"设备IP"},1:{name:"port",key:"device_port",empty:""},2:{name:"provider",key:"device_provider",empty:"设备厂家"},3:{name:"style",key:"device_style",empty:"设备型号"},4:{name:"driverId",key:"device_driverId",empty:"厂家及型号"},5:{name:"username",key:"device_username",empty:""},6:{name:"password",key:"device_password",empty:""}},ya={server:{clz:"server-edit",tpl:X,checkers:C([xa[0],xa[1],{name:"version",key:"device_version",empty:""}])},storage:{clz:"storage-edit",tpl:Y,checkers:C([xa[1],xa[4],xa[5],xa[6],{name:"diskNum",key:"device_diskNum",empty:"硬盘数量"},{name:"dataIp",key:"device_dataIp",empty:"数据口IP"},{name:"manageIp",key:"device_manageIp",empty:"管理口IP"},{name:"capacity",key:"device_capacity",empty:"存储总容量"}])},pickup:{clz:"pickup-edit",tpl:Z,checkers:C([xa[2],xa[3],{name:"relatedCamera",key:"device_relatedCamera",empty:""}])},spliter:{clz:"spliter-edit",tpl:$,checkers:C([xa[4],{name:"maxWindow",key:"device_maxWindow",empty:""},{name:"commPort",key:"device_commPort",empty:""},{name:"baudRate",key:"device_baudRate",empty:""},{name:"dataBit",key:"device_dataBit",empty:""},{name:"parityBit",key:"device_parityBit",empty:""},{name:"stopBit",key:"device_stopBit",empty:""},{name:"decoders",key:"device_relatedDecoders",empty:""}])},terminal:{clz:"terminal-edit",tpl:aa,checkers:C([xa[0]])},other:{clz:"other-edit",tpl:ba,checkers:C([xa[2],xa[3],{name:"path",key:"device_path",empty:"对应的软件名称或网页地址"}])},decoder:{clz:"decoder-edit",tpl:ca,checkers:C([xa[4],xa[0],xa[1],xa[5],xa[6],{name:"channelNum",key:"device_channelNum",empty:"设备通道数"}])},specialDecoder:{clz:"decoder-edit",tpl:da,checkers:C([xa[4],xa[0],xa[1],xa[5],xa[6],{name:"channelNum",key:"device_channelNum",empty:"设备通道数"},{name:"maxWindow",key:"device_maxWindow",empty:"通道最大画面数"}])},monitor:{clz:"monitor-edit",tpl:ea,checkers:C([xa[2],xa[3]])},coder:{clz:"coder-edit",tpl:fa,checkers:C([xa[4],xa[0],xa[1],xa[5],xa[6],{name:"channelNum",key:"device_channelNum",empty:""},{name:"bc",key:"device_bc",empty:""}])},vdm:{clz:"vdm-edit",tpl:_,checkers:C([xa[4],{name:"commPort",key:"device_commPort",empty:""},{name:"baudRate",key:"device_baudRate",empty:""},{name:"dataBit",key:"device_dataBit",empty:""},{name:"parityBit",key:"device_parityBit",empty:""},{name:"stopBit",key:"device_stopBit",empty:""},{name:"relatedCamera",key:"device_relatedCamera",empty:""}])},IPC:{clz:"IPC-edit",tpl:ga,checkers:C([xa[4],xa[0],xa[1],xa[5],xa[6],{name:"bcAddr",key:"device_bcAddr",empty:"组播流地址"},{name:"bcPort",key:"device_bcPort",empty:"组播流端口"},{name:"channelNum",key:"device_channelNum",empty:""},{name:"zoneId",key:"zone_id",empty:""},{name:"id",key:"device_id",empty:""}])},camera:{clz:"camera-edit",tpl:ha,checkers:C([xa[4],{name:"coderId",key:"coder_id",empty:"关联编码器"},{name:"channelNo",key:"channel_no",empty:"关联编码器的通道号"
},{name:"zoneId",key:"zone_id",empty:""},{name:"controlParams",key:"device_controlParams",empty:""},{name:"bitsets",key:"device_bitsets",empty:""}])}};IX.ns("TCM.DeviceDialog"),TCM.DeviceDialog.editDevice=function(a,b,c){var d=[a.get("type")],e=U(d[0]);y(d[0],function(f){o(a,IX.inherit(ya[e],{title:"编辑设备",callerName:"editDevice",tpldataFn:function(a,b){return G(a,b,d,f)}}),b,d,c)})},TCM.DeviceDialog.createDevice=function(a,b,c){var d=U(a[0]);y(a[0],function(e){o(null,IX.inherit(ya[d],{title:"添加设备",callerName:"addDevice",tpldataFn:function(b,c){return G(b,c,a,e)}}),b,a,c);for(var f=TCM.Device.getDriver,g=jQuery("#device_driverId").attr("value"),h=0;h<V.length;h++){var i=f(g);i.name==V[h].name&&i.provider==V[h].provider&&i.style==V[h].style&&jQuery("#device_port").attr("value",V[h].port)}})},TCM.DeviceDialog.deleteDevices=function(a,b,c){l(a,{title:"确认删除",unitName:"个设备",callerName:"deleteDevices"},b,c)};var za=new IX.ITemplate({tpl:['<li class="expand">','<a class="tree-node" data-href="$tree.click" data-key="20,21,22,31,32,33" data-siteid="{siteId}" data-name="{zoneName}" data-zoneid="{zoneId}">','<span class="pic-expand"></span><span><span class="nodeName">{zoneName}</span><span class="count">({fixed})</span></span>',"</a>",'<a class="deleteZone r" data-href="$zone.delete" data-key="{zoneId}"></a>','<a class="editZone r" data-href="$zone.edit" data-key="{zoneId}"></a>','<ul style="display: none;">','<tpl id="items">','<li class="none">','<a class="tree-node" data-href="$tree.click" data-key="{type1},{type2}" data-siteid="{siteId}" data-name="{name}" data-zoneid="{zoneId}">','<span class="pic-expand"></span><span>{name}<span class="count">({count})</span></span>',"</a>","</li>","</tpl>","</ul>","</li>",""]}),Aa=new IX.ITemplate({tpl:["<ul>",'<li><span class="label">原名称 </span><span class="oldName">{oldName}</span></li>','<li><span class="label">新名称 </span><span><input id="zone_name" value=""></span></li>',"</ul>",""]}),Ba=new IX.ITemplate({tpl:['<ul><li><span class="label">分区名</span><span><input id="zone_name" value=""></span></li></ul>',""]});IX.ns("TCM.TreeDialog"),TCM.TreeDialog.addZone=function(a,b,c){function d(){var a=$X("zone_name").value;return IX.isEmpty(a)?O("分区名称不能为空！"):g(a)?void J("addZone",{name:a},function(a){H(a,c),M(),P("添加分区成功！")}):O('分区名称请勿包含\\/^:*><|@?"特殊字符！')}L({clz:"device-addZoneBlock",title:"新建分区",content:Ba.renderData(""),listen:{ok:d}})},TCM.TreeDialog.editZone=function(a,b,c){function d(a){var b=$X("zone_name").value;return IX.isEmpty(b)?O("新分区名称不能为空！"):g(b)?void J("editZone",{id:f,name:b},function(c){jQuery(".tree-node").next().children("li").each(function(){var c=jQuery(this).children("a").first();c.attr("data-zoneid")==f&&(c.attr("data-name",b),jQuery(a).parent().find(".nodeName").html(b),jQuery("#Grid").find(".nv-title").html(b+"摄像机列表"))}),M(),P("修改成功！")}):O('分区名称请勿包含\\/^:*><|@?"特殊字符！')}var e=IX.encodeTXT(jQuery(b).prev().prev().attr("data-name")),f=jQuery(b).prev().prev().attr("data-zoneid");L({clz:"device-editZone",title:"修改名称",content:Aa.renderData("",{oldName:e}),listen:{ok:function(){d(b)}}})},TCM.TreeDialog.deleteZone=function(a,b){function c(){d.remove();var a=e.children("li").first().children("a").first().find(".count");0===a.length?(jQuery("#Grid").find(".body").html(""),jQuery("#Grid").find(".nv-title").html("摄像机列表"),jQuery(".btn-create").removeClass("btn-create").addClass("btn-discreate")):a.click()}var d=jQuery(b).parent("li"),e=d.parent();N("删除分区",W.renderData("",{count:"个分区",units:d.children("a").first().attr("data-name")}),function(b){J("deleteZone",{ids:[a.key]},function(a){b(),P("删除分区成功！"),c()})})};var Ca=new IX.ITemplate({tpl:['<ul class="{clz}">','<li><span class="label">车站选择</span>','<span><input id="station" disabled="disabled" value="{station}"></span>','<span class="label">分区</span>','<span><input id="theZone" disabled="disabled" value="{theZone}"></span></li>','<li id="choose">{chooseCameras}</li>',"</ul>",""]});IX.ns("TCM.ZoneDialog"),TCM.ZoneDialog.addCameras=function(a,b){function c(){var a=jQuery(".select").attr("data-zoneid"),c=T.getCamera4TypeAccess($X("choose"));return 0===c.length?O("请选择需要添加的摄像机到分区！"):void J("addCamerasToZone",{id:a,cameras:c.ids},function(d){jQuery(".btn-discreate").removeClass("btn-discreate").addClass("btn-create"),b(c),I(a,d),M()})}J("getCamerasByNoZone",{},function(b){return 0===b.length?O("暂时无可分配的摄像机！"):(L({clz:"cameraToZone",title:"新增摄像机",content:Ca.renderData("",{station:jQuery(".nv-tree .nodeName").first().html(),theZone:jQuery("a.select").attr("data-name")||"",chooseCameras:T.getCamera4TypesHTML(b,a)}),listen:{ok:c}}),void IX.bind(jQuery("#choose").get(0),{click:function(a){if(!$XD.ancestor(a.target,"a")){var b=$XH.ancestor(a.target,"type");jQuery(b).siblings(".type").removeClass("expanded"),jQuery(b).siblings(".type").find(".nv-collapse").addClass("expanded"),$XH.toggleClass(b,"expanded"),jQuery(b).find(".nv-collapse").toggleClass("expanded")}}}))})},TCM.TreeDialog.deleteCameras=function(a,b,c,d){l(a,{title:"确认删除",unitName:"个摄像机",callerName:"deleteCamerasFromZone"},b,c,d)}}(),function(){function a(a){var b=jQuery("#Grid").height();jQuery("#Tree").css("height",b+"px"),a?jQuery(".nv-tree").css("maxHeight",b-85+"px"):jQuery(".nv-tree").css("height",b-55+"px")}function b(b,c){function d(a){TCM.DeviceDialog.createDevice(h,function(b){a(b)},i)}function e(a,b){TCM.DeviceDialog.deleteDevices(a,function(){b()},i)}var f=null,g=["_checkbox"].concat($XP(b,"columns").split(",")),h=c.types,i=c.siteId,j=c.types.length;f=new TCM.Lib.Grid($XP(b,"container","Grid"),{title:$XP(c,"name"),grid:{clz:j>=15?"device-list":"device-list-"+c.types[0],columns:g,actions:H?["delete",["edit","编辑",function(a,b){TCM.DeviceDialog.editDevice(a,function(){f.refresh()},i)}]]:[],hasCheckbox:$XP(b,"hasCheckbox")||!0,usePagination:$XP(b,"usePagination")||!0,dataLoader:function(b,d){x("getDevices4Type",IX.inherit(b,{types:c.types,siteId:c.siteId}),function(b){d(b),a(),$Xw.bind({resize:a})})}},tools:{buttons:H?h.length>7?["refresh","delete"]:["refresh","create","delete"]:["refresh"]},listen:{createItem:d,deleteItems:e}})}function c(b){function c(a){TCM.ZoneDialog.addCameras(e,function(b){a(b)})}function d(a,b){TCM.TreeDialog.deleteCameras(a,function(){b()},g,f)}var e=b.types,f=b.zoneId,g=b.siteId,h=R.renderData("",{zoneId:f,siteId:g,types:e,name4Zone:b.name+"列表"});return new TCM.Lib.Grid($XP(b,"container","Grid"),{title:h,grid:{clz:"device-list",columns:["_checkbox","devType","devName","devDesc"],actions:G?[]:["delete"],hasCheckbox:!0,usePagination:!0,dataLoader:function(b,c){x("getCamerasByZone",IX.inherit(b,{types:e,siteId:g,id:f}),function(b){c(b),0===jQuery(".select").length&&jQuery(".btn-create").removeClass("btn-create").addClass("btn-discreate"),jQuery("#Grid").removeClass("showMap"),a(!G),$Xw.bind({resize:function(){a(!G)}})})}},tools:{buttons:G?["refresh"]:["refresh","create","delete"]},listen:G?{}:{createItem:c,deleteItems:d}})}function d(a){jQuery(".grid-navbar").removeClass("chooseBar"),jQuery(a).addClass("chooseBar"),jQuery("#Grid").toggleClass("showMap"),jQuery("#body").toggleClass("disable-scroll")}function e(a){var c=IX.map(a.keys.split(","),function(a){return Number(a)}),d=TCM.DeviceType.getNodeName(c[0]);c.length>6&&(d="all"),H=a.siteId==F.id?!0:!1,b(S[d],{types:c,siteId:a.siteId,name:a.name+"列表",el:a.el})}function f(a){var b=IX.map(a.keys.split(","),function(a){return Number(a)});c({types:b,siteId:a.siteId,zoneId:a.zoneId,name:IX.encodeTXT(a.name)}),jQuery("#body").removeClass("disable-scroll")}function g(a,b,c){function d(a){return IX.map(a,function(a){return IX.inherit(a,e(a))})}function e(a){if(a.key)return{key:a.key,count:b[a.key[0]]?b[a.key[0]]:0,siteId:c,nodes:[]};for(var e=[],f=0,g=0===a.nodes?[]:d(a.nodes),h=0;h<g.length;h++)e=e.concat(g[h].key),f+=g[h].count;return{key:e,count:f,siteId:c,nodes:g}}return G?d(a).pop():{nodes:d(a)}}function h(a){return IX.map(a,function(a,b){return{name:z[a],key:[a]}})}function i(a){x("getAllDevices",{},function(b){if(G){var c=IX.map(b,function(a,b){var c={};IX.iterate(a.devices,function(a){c[a.type]=a.count});var d=TCM.LineInfo.getSites().get(a.siteId),e=[];return 1==d.type?e=[IX.inherit(U,{name:d.name})]:(T[0].name=d.name,e=T),g(e,c,a.siteId);
});a({nodes:c})}else{T[0].name=F.name;var d={},e={};IX.iterate(b,function(a){e=a,IX.iterate(a.devices,function(a){d[a.type]=a.count})}),a(g(T,d,e.siteId))}})}function j(a,b){var c=a.siteId,d=IX.map(a.zones,function(a){var b=a.id,d=a.total,e=[{name:"枪机",key:[20,31],count:d.fixed},{name:"半球",key:[21,32],count:d.semi},{name:"球机",key:[22,33],count:d.sphere}];return{name:a.name,key:[20,21,22,31,32,33],count:d.fixed+d.semi+d.sphere,zoneId:b,siteId:c,nodes:IX.map(e,function(a){return IX.inherit(a,{zoneId:b,siteId:c,nodes:[]})})}});return{name:b,nodes:d}}function k(a){x("getAllZones",{},function(b){var c=TCM.LineInfo.getSites();a(G?{nodes:IX.loop(b,[],function(a,b){return F.id!=b.siteId&&a.push(j(b,c.get(b.siteId).name)),a})}:{nodes:[j(b.pop(),F.name)]})})}function l(){G?(jQuery(".nv-tree>ul>li>ul>li").children("ul").hide(),jQuery(".nv-tree>ul>li").children("ul").hide()):jQuery(".nv-tree>ul>li>ul>li").children("ul").hide(),jQuery(".nv-tree>ul>li>a span.count").hide()}function m(a){i(function(a){var b=IX.inherit(a,{htmlFn:function(a){return'<span class="nodeName" title='+IX.encodeTXT(a.name)+">"+IX.encodeTXT(a.name)+'</span><span class="count">('+a.count+")</span>"},click:e}),c=new TCM.Lib.Tree(b);if($X("body").innerHTML=P.renderData("",{treeName:G?"线路设备列表":"单位设备列表",treeData:c.getHTML(),addZone:"",showZone:""}),l(),G)jQuery("[data-name="+F.name+"]").find("span").each(function(a,b){(0===a||2===a)&&this.click()});else{var d=jQuery(".nv-tree li:first a:first span.count");d.parents("li").removeClass("expand").addClass("fold"),d.click()}jQuery("#body").removeClass("disable-scroll")}),a()}function n(a){k(function(a){var b=IX.inherit(a,{htmlFn:function(a){var b=G?"":a.zoneId&&3==a.nodes.length?'<a class="deleteZone r" data-href="$zone.delete" data-key="'+a.zoneId+'"></a><a class="editZone r" data-href="$zone.edit" data-key="'+a.zoneId+'"></a>':"";return'<span class="nodeName" title='+IX.encodeTXT(a.name)+">"+IX.encodeTXT(a.name)+'</span><span class="count">('+a.count+")</span>"+b},click:f}),c=new TCM.Lib.Tree(b);$X("body").innerHTML=P.renderData("",{treeName:G?"线路分区列表":"单位分区列表",treeData:c.getHTML(),addZone:G?"":Q.renderData("",{}),showZone:"showZone"}),l();var d=jQuery(".nv-tree li:first li:first a:first span.count");0===d.length?f({keys:"20,21,22,31,32,33",name:"",zoneId:"",siteId:F.id}):(d.click(),G?jQuery(".nv-tree>ul>li>a>.pic-expand").get(0).click():jQuery(d.parents("li")[1]).removeClass("expand").addClass("fold"))}),a()}function o(a,b,c){var d=[],e=!0;return d=IX.loop(c,[],function(c,d,f){if(d.id==b){c=[],IX.Array.isFound(a,d.channels)||d.channels.unshift(a);for(var g=0;g<d.channels.length;g++)c.push({id:d.channels[g],name:d.channels[g]});e=!1}else a&&(c=[{id:a,name:a}]);return c}),e&&b&&c.unshift(N.spliter||N.decoder||N.specialDecoder),d}function p(a,b,c){var d=[];return d="1"==c?o(a,b,N.notRelatedSpliter):"2"==c?o(a,b,N.notRelatedDecoder):o(a,b,N.notRelatedSpecialDecoder),D("device_relatedChannel",{value:a||"",valueText:a||"",items:d})}function q(a,b,c,d){function e(a,b,c){return D(a,{value:b.id||"",valueText:b.name||"",items:IX.map(c,function(a){return{id:a.id,name:a.name,action:"pick.device"}})})}function f(){if(H){var a={};if(a.monitor=$X("device_monitor").value,a.spliter=$X("device_spliter")?$X("device_spliter").value:"",a.decoder=$X("device_decoder")?$X("device_decoder").value:"",a.specialDecoder=$X("device_specialDecoder")?$X("device_specialDecoder").value:"",a.relatedChannel=$X("device_relatedChannel")?$X("device_relatedChannel").value:"",""===a.monitor)return E("请选择相应的监视器！");if(""===a.spliter&&""===a.decoder&&""===a.specialDecoder)return E("监视器至少关联一个解码器或画面分割器！");if(""===a.relatedChannel&&"3"==$X("device_choose").value)return E("关联设备的通道数不能为空！");a.id=c.id?c.id:"",x(d?"editVideoWall":"addVideoWall",a,function(a){b(a),B()})}}if(N=c,d?(c.notRelatedMonitor.unshift(c.monitor),c.spliter.id&&(O=p(c.spliter.relatedChannel,c.spliter.id,"1")),c.decoder.id&&(O=p(c.decoder.relatedChannel,c.decoder.id,"2")),c.specialDecoder.id&&(O=p(c.specialDecoder.relatedChannel,c.specialDecoder.id,"3"))):O=p("","",""),!d&&0===c.notRelatedMonitor.length)return E("请添加监视器后再添加电视墙！");if(!d&&0===c.notRelatedSpecialDecoder.length)return E("没有可用的解码器！");K=e("device_spliter",c.spliter,c.notRelatedSpliter),L=e("device_decoder",c.decoder,c.notRelatedDecoder),M=e("device_specialDecoder",c.specialDecoder,c.notRelatedSpecialDecoder);var g=null;g=d&&c.spliter.id?K:d&&c.specialDecoder.id?M:L;var h=[{id:1,name:"画面分割器",action:"pick.one"},{id:2,name:"解码器",action:"pick.one"},{id:3,name:"解码器",action:"pick.one"}],i=V.renderData("",{relatedMonitor:D("device_monitor",{value:c.monitor.id||"",valueText:c.monitor.name||"",items:IX.map(c.notRelatedMonitor,function(a){return{id:a.id,name:a.name}})}),relatedSD:D("device_choose",{value:3,valueText:"解码器",items:[h[2]]}),relatedSDR:M,relatedChannel:O});if(A({clz:"video-edit",title:H?c?"编辑电视墙":"新增电视墙":"查看电视墙",content:i,listen:{ok:f}}),G){var j=jQuery("#device_choose_combo");j.attr("data-toggle",""),j.find(".pic-").hide()}H||(jQuery(".content").find("button").each(function(){jQuery(this).attr("data-toggle","")}),jQuery(".content").find(".pic-").each(function(){jQuery(this).hide()}),jQuery(".btn.okbtn").hide())}function r(a,b){var c=null!==a;x("getVideoWall",c?{id:a.id}:{},function(a){q(F,b,a,c)})}function s(a){var b=a.spliter||a.decoder||a.specialDecoder;return IX.inherit(a,{monitorName:a.monitor.name,monitorProvider:a.monitor.provider?a.monitor.provider:"",monitorStyle:a.monitor.style?a.monitor.style:"",machineName:b.name||"",machineProvider:TCM.Device.getDriver(b.driverId).provider+" "+TCM.Device.getDriver(b.driverId).style||"",relatedName:52==b.type?"画面分割器：":"解码器："})}function t(a,b){x("getVideoWalls",a,function(a){var c=IX.map(a,function(a){return Y.register(a.id,a),s(a)});jQuery("#show-plan").find(".store-plans").get(0).innerHTML=X.renderData("",{plans:b?IX.map(c,function(a){return a.hasClz="hasHover",a}):c,clz:b?"add":"notOCC"})})}function u(){var a=IX.loop(TCM.LineInfo.getSites().getAll(),[],function(a,b,c){return 0!==b.type&&4!==b.type&&5!==b.type&&6!==b.type&&a.push({name:b.name,key:b.id,nodes:[]}),a}),b=IX.inherit({nodes:[{name:TCM.LineInfo.getName(),nodes:a}]},{htmlFn:function(a){return'<span class="nodeName">'+a.name+"</span>"},click:function(a,b){var c=a.keys;H=c==F.id?!0:!1,t({siteId:c},H)}});return new TCM.Lib.Tree(b).getHTML()}function v(){var a=jQuery("#show-plan").height();jQuery("#Tree").css("height",a+"px"),jQuery(".nv-tree").css("height",a-55+"px")}function w(a){if(Y.clear(),G){var b=u();$X("body").innerHTML=W.renderData("",{treeName:"单位列表",clz:"",tree:b}),l(),jQuery("#Tree").find("span.nodeName").each(function(){this.innerHTML==F.name&&this.click()}),jQuery(".nv-tree a:first span:first").click(),v(),$Xw.bind({resize:v})}else H=!0,$X("body").innerHTML=W.renderData("",{treeName:"",clz:"notOCC",tree:""}),t({},H);a()}var x=TCM.Global.deviceAndZoneCaller,y=IXW.Actions.configActions,z=TCM.Const.DeviceTypeNames,A=NV.Dialog.show,B=NV.Dialog.hide,C=NV.Dialog.confirm,D=NV.Lib.getComboHTML,E=(TCM.Lib.CameraTree,NV.Dialog.alert),F=null,G=null,H=null,I={},J=null,K=null,L=null,M=null,N=null,O=null,P=(new IX.ITemplate({tpl:['<div><input class="search" placeholder="设备选择"><a class="pic-search"></a></div>',""]}),new IX.ITemplate({tpl:['<div id="Tree"><div id="treeName">{treeName}</div>{treeData}','<div class="addZone">{addZone}',"</div>","</div>",'<div id="Grid" class="{showZone}"></div>',""]})),Q=new IX.ITemplate({tpl:['<a data-href="$zone.add"><span></span>添加分区</a>',""]}),R=new IX.ITemplate({tpl:['<a class="grid-navbar chooseBar" data-href="$show.grid" data-zoneId="{zoneId}" data-siteId="{siteId}" data-types="{types}">{name4Zone}</a>','<span class="vertical">|</span>','<a class="grid-navbar" data-href="$show.map" data-zoneid="{zoneId}" data-siteid="{siteId}">地图</a>',""]});y([["zone.add",function(a,b,c){TCM.TreeDialog.addZone(a,b,F)}],["zone.delete",function(a,b,c){TCM.TreeDialog.deleteZone(a,b)}],["zone.edit",function(a,b,c){TCM.TreeDialog.editZone(a,b,F)}],["show.grid",function(a,b,e){d(b);var f=jQuery(b);c({types:$XD.dataAttr(b,"types").split(","),siteId:$XD.dataAttr(b,"siteid"),zoneId:$XD.dataAttr(b,"zoneid"),name:f.html().slice(0,-2)})}],["show.map",function(a,b,c){
var e=$XD.dataAttr(b,"zoneid");if(!e)return E("请先添加分区，再查看地图信息！");d(b),jQuery(".nvgrid-tools").remove(),jQuery(".nvgrid-foot").remove();var f=new TCM.Lib.Map(jQuery(".nvgrid-body").get(0),{siteId:$XD.dataAttr(b,"siteid"),zoneId:e},G);f.show()}]]);var S={all:{columns:"devType,devName,devDesc"},server:{columns:"devType,devName,devIp,devVersion,devDesc"},storage:{columns:"devName,devManageIp,devPort,devdiskNum,devCapacity,devDesc"},IPC:{columns:"devType,devName,Provider,Style,devIp,devPort,devDesc"},camera:{columns:"devType,devName,devProvider,devStyle,devDesc"},pickup:{columns:"devType,devName,devProvider,devStyle,devDesc"},coder:{columns:"devName,Provider,Style,devIp,devPort,devChannelNum,devDesc"},decoder:{columns:"devName,Provider,Style,devIp,devPort,devChannelNum,devDesc"},specialDecoder:{columns:"devName,Provider,Style,devIp,devPort,devChannelNum,devDesc"},spliter:{columns:"devName,Provider,Style,devMaxWindow,devDesc"},monitor:{columns:"devName,devProvider,devStyle,devDesc"},terminal:{columns:"devName,devIp,devDesc"},vdm:{columns:"devName,Provider,Style,devDesc"},other:{columns:"devType,devName,devProvider,devStyle,devPath,devDesc"}},T=[{name:"",nodes:[{name:"服务器",nodes:h([1,2,3])},h([10])[0],{name:"数字摄像机",nodes:h([20,21,22])},{name:"模拟摄像机",nodes:h([31,32,33])},{name:"拾音器",nodes:h([40,41])},h([50])[0],h([55])[0],h([53])[0],h([54])[0],{name:"网络和附属设备",nodes:h([60,61,62,63,64,90])}]}],U={name:"",nodes:[{name:"服务器",nodes:h([0,1,2,3])},h([10])[0],h([55])[0],h([53])[0],h([54])[0],{name:"网络和附属设备",nodes:h([60,61,62,63,64,90])}]},V=new IX.ITemplate({tpl:['<ul class="videoWallEdit">','<li><span class="label">监视器</span>{relatedMonitor}</li>','<li><span class="label">关联的设备类型</span>{relatedSD}</li>','<li><span class="label choose">关联设备名称</span>{relatedSDR}</li>','<li><span class="label channel">关联设备通道号</span>{relatedChannel}</li>',"</ul>",""]}),W=new IX.ITemplate({tpl:['<div id="Tree" class="{clz}"><div id="treeName">{treeName}</div>{tree}</div>','<div id="show-plan" class="nv-box">','<div class="nv-title">电视墙</div>','<ul class="store-plans"></ul>',"</div>",""]}),X=new IX.ITemplate({tpl:['<tpl id="plans">','<li class="{hasClz}"><a data-href="$video.edit" data-key="{id}">','<div class="pic-">','<div><span class="label">监视器：</span><span>{monitorName}</span></div>','<div><span class="label">(厂家 型号)：</span><span title="{monitorProvider} {monitorStyle}">{monitorProvider} {monitorStyle}</span></div>','<div><span class="label">{relatedName}</span><span>{machineName}</span></div>','<div><span class="label">(厂家 型号)：</span><span title="{machineProvider}">{machineProvider}</span></div>',"</div>",'</a><a class="pic-del" data-href="$video.delete" data-key="{id}">',"</a></li>","</tpl>",'<li class="{clz}"><a data-href="$video.add">','<div class="pic-"></div>','<div class="name">添加电视墙</div>',"</a></li>",""]}),Y=new IX.IListManager;y([["video.add",function(a,b){r(null,function(a){Y.register(a.id,a),a.hasClz="hasHover";var c=X.renderData("plans",s(a));jQuery(c).insertBefore(b.parentNode)})}],["video.edit",function(a,b){var c=a.key,d=Y.get(c);d&&r(d,function(a){Y.register(d.id,a),a.hasClz="hasHover";var c=X.renderData("plans",s(a));b.parentNode.innerHTML=c.substring('<li class="hasHover">'.length,c.length-"</li>".length)})}],["video.delete",function(a,b){if(H){var c=a.key,d=Y.get(c);d&&C("删除电视墙","请确认是否删除此电视墙？",function(a){x("deleteVideoWall",{ids:[d.id]},function(){Y.remove(c);var a=b.parentNode;a.parentNode.removeChild(a),B()})})}}],["pick.one",function(a,b){var c=a.key,d=b.innerHTML,e=$XH.ancestor(b,"dropdown");if(e){var f=$XD.first(e,"input");if(f.value!=c){f.value=c;var g=$XH.first($XH.first(e,"dropdown-toggle"),"name");g.innerHTML=d;var h=jQuery(".choose");h.next().remove(),"1"==c?jQuery(K).insertAfter(h):"2"==c?jQuery(L).insertAfter(h):jQuery(M).insertAfter(h);var i=jQuery(".channel");i.next().remove(),jQuery(p("","",$X("device_choose").value)).insertAfter(i)}}}],["pick.device",function(a,b){var c=a.key,d=b.innerHTML,e=$XH.ancestor(b,"dropdown");if(e){var f=$XD.first(e,"input");if(f.value!=c){f.value=c;var g=$XH.first($XH.first(e,"dropdown-toggle"),"name");g.innerHTML=d;var h=jQuery(".channel");h.next().remove(),jQuery(p("",c,$X("device_choose").value)).insertAfter(h)}}}]]),IX.ns("TCM.Device"),TCM.Device.init=function(a,b,c){switch(J||x("getDriver",{},function(a){J=a,IX.iterate(a,function(a,b){var c={};c.id=a.id,c.provider=a.provider+"-"+a.style,I[a.type]?I[a.type].push(c):I[a.type]=[c]})}),F=TCM.Env.getSession().getCurrentSite(),G=1==TCM.Env.getSession().getCurrentSiteType()?!0:!1,a.name){case"device-list":m(c);break;case"device-zone":n(c);break;case"device-video":w(c)}},TCM.Device.getDriver4Type=function(a){return I[a]},TCM.Device.getDriver=function(a){for(var b=0;b<J.length;b++)if(a==J[b].id)return J[b]}}(),function(){function a(a){return IX.map(a,function(a){return IX.inherit(a,{action:"store.pick"})})}function b(a){switch(a){case L.IPCFixed:case L.CameraFixed:return 0;case L.IPCSphere:case L.CameraSphere:return 1;case L.IPCSemiSphere:case L.CameraSemiSphere:return 2}return 0}function c(a){var c=[[],[],[]];return IX.iterate(a,function(a){var d=b(a.type);c[d].push({action:"cameras.move",chkClz:a.selected?"selected":"",id:a.id,name:a.name,type:a.type})}),c}function d(a){return IX.loop(a,[],function(a,b,c){return 0===b.length?a:(a.push({clz:"show-cameras"+c,items:b}),a)})}function e(a){var b=c(a),e=d(b);return I.renderData("",{types:e})}function f(a,b){var c=[[]];IX.iterate(b,function(b){c[0].push({chkClz:IX.loop(a,[],function(a,c){return c.id==b.id&&a.push("selected"),a}).pop(),action:"cameras.move",id:b.id,name:b.name})});var e=d(c);return I.renderData("",{types:e})}function g(a){var b=0;return IX.iterate(a,function(a,c){a.chkClz&&b++}),a.length===b?"selected":0===b?"":"part"}function h(a){var b=c(a);return IX.loop(b,[],function(a,b,c){return 0===b.length?a:(a.push({clz:"cameras"+c,action:"cameras.move",chkClz:g(b),expClz:"expanded",type:c,name:M[c],items:b}),a)})}function i(a){var b=IX.map(a,function(a){return{name:a.name,chkClz:"",expClz:"",types:h(a.cameras)}});return K.renderData("",{zones:b})}function j(a,b){return IX.map(b,function(b){return IX.inherit(b,{clz:IX.Array.isFound(b.id,a)?"selected":""})})}function k(a){return IX.map(a,function(a){return a.id})}function l(a){var b=$X("caseCameraPanel");return $XH.first(b,"type")||(jQuery(b).append(jQuery("<div>"+a.cameraRefreshHTML()+"</div>")),IX.bind(b,{click:function(a){if(!$XD.ancestor(a.target,"a")){var b=$XH.ancestor(a.target,"type")||$XH.ancestor(a.target,"zone");$XH.toggleClass(b,"expanded"),jQuery(b).find(".nv-collapse").toggleClass("expanded")}}})),{show:function(){b.style.display="block",jQuery(".camera-move").css("display","block"),jQuery(".plan-content").css("left","-330px")},hide:function(){b.style.display="none",jQuery(".camera-move").css("display","none"),jQuery(".plan-content").css("left","50px")}}}function m(a,b){function c(a,b){var c=jQuery("#daysName"),d=jQuery("#caseDaysPanel"),e=jQuery("#dayall");b?7!==q.days.length?c.find('[data-key="'+a+'"]').addClass("show-day"):(q.days="all",d.find('[data-key="all"]').addClass("selected"),c.find(".day").removeClass("show-day"),e.addClass("show-day")):(6===q.days.length&&(d.find('[data-key="all"]').removeClass("selected"),c.find(".day").addClass("show-day")),d.find('[data-key="'+a+'"]').removeClass("selected"),c.find('[data-key="'+a+'"]').removeClass("show-day"),e.removeClass("show-day")),V.setPos()}function d(a,b){return"all"===a?(jQuery("#daysName .day").removeClass("show-day"),jQuery("#dayall")[b?"addClass":"removeClass"]("show-day"),jQuery("#caseDaysPanel .nv-checkbox")[b?"addClass":"removeClass"]("selected"),V.setPos(),q.days=b?"all":null):void(b?(q.days?q.days.push(a):q.days=[a],c(a,b)):(Array.isArray(q.days)?q.days=IX.Array.remove(q.days,a):q.days=IX.Array.remove([0,1,2,3,4,5,6],a),c(a,b)))}function g(a,b,c){c?q[a].push(b):q[a]=IX.Array.remove(q[a],b)}function h(){return q.days&&0!==q.days.length?q.to<=q.from?(A("录像开始时间必须小于结束时间！"),!1):0===q.storages.length?(A("存储服务器不能为空！"),!1):R&&0===q.monitors.length?(A("监视器不能为空！"),!1):R||0!==q.cameras.length?q:(A("摄像机不能为空！"),!1):(A("日期计划不能为空！"),!1)}function l(a,b){for(var c=0;c<a.length;c++)if(a[c].id==b)return a[c].name;
return""}function m(a,b,c,d){return B(a,{value:b,valueText:c,items:d})}function n(a,b){return IX.loop(b,[],function(b,c){return"all"==a&&a==c.id?c=IX.inherit(c,{clz:"show-day"}):IX.iterate(a,function(a){a==c.id&&(c=IX.inherit(c,{clz:"show-day"}))}),b.push(c),b})}function o(){function c(){if(R&&T){var c=a.id?a.monitors:[];return P.renderData("",{showMonitor:f(c,c.concat(b.monitors))})}return O.renderData("",{showCamera:e(a.id?IX.map(a.cameras,function(a){return IX.inherit(a,{selected:!0})}):[])})}var d=l(G,q.circle)||"30",g=l(D,q.from)||"00:00",h=l(E,q.to)||"24:00";return{siteName:S.name,plan_name:q.name,circleCombo:m("plan_circle",q.circle,d,G),dayitems:n(q.days,F),fromCombo:m("plan_from",q.from,g,D),toCombo:m("plan_to",q.to,h,E),ss:j(q.storages,b.storages),showDevices:c()}}var p={days:"all",circle:30,from:"00:00",to:"24:00",storages:[]},q=IX.inherit(p,{siteId:S.id},a,a.storages?{storages:k(a.storages)}:[],R?{monitors:a.monitors?k(a.monitors):[]}:{cameras:a.cameras?k(a.cameras):[]});return V=new IXW.Lib.PopTrigger({id:"caseDaysPanel",ifKeepPanel:function(a){return!!$XH.ancestor(a,"days-choose")},bodyRefresh:function(a,b){var c=U.getPlanDays(),d=F.slice(1,F.length);a.innerHTML=Q.renderData("",{clz:"all"==c?"selected":"",name:"全周",items:j("all"==c?"0123456".split(""):c,d)})}}),{getTplData:o,setProperty:function(a,b){q[a]=b},setDays:d,setArr:g,getPlanDays:function(){return q.days},cameraRefreshHTML:function(){var a=i(b.zones);return a?a:'<span class="hint">没有未分配的摄像机，请添加摄像机后再试！</span>'},getData:h}}function n(a,c,d){var e=Number($XD.dataAttr(c,"type")),f=jQuery($XH.ancestor(c,"one-cameras"));if(jQuery('[data-key="'+a+'"]')[d?"addClass":"removeClass"]("selected"),d&&0===jQuery('.showCamera [data-key="'+a+'"]').length){var g=jQuery(".show-cameras"+b(e));0===g.length&&(g=jQuery('<div class="node show-cameras'+b(e)+'"></div>'),jQuery(".showCamera").append(g)),g.append(jQuery(c.parentNode).clone())}U.setArr("cameras",a,d);var h=f.find(".nv-checkbox").length;if(0!==h){var i=f.find(".selected").length,j=f.prev().find(".nv-checkbox"),k=j.parents(".type-cameras");if(i===h){if(j.removeClass("part").addClass("selected"),k.find(".type .nv-checkbox").length==k.find(".type .selected").length)return k.prev(".zone").find(".nv-checkbox").removeClass("part").addClass("selected")}else if(0===i){if(j.removeClass("part").removeClass("selected"),0===k.find(".type .selected").length)return k.prev(".zone").find(".nv-checkbox").removeClass("part").removeClass("selected")}else j.removeClass("selected").addClass("part");k.prev(".zone").find(".nv-checkbox").removeClass("selected").addClass("part")}}function o(a,b){jQuery(a.parentNode).next().find(".nv-checkbox").each(function(){var a=jQuery(this).attr("data-key");n(a,this,b)})}function p(a,b,c){v("getDevices4Plan",{siteId:a},function(a){function d(){if(T){var d=U.getData(),e=$X("plan_name").value.trim();if(!e)return A("计划名称不能为空！");if(d){d.name=e;var f=IX.loop(a.storages,[],function(a,b){for(var c=0;c<d.storages.length;c++)d.storages[c]==b.id&&a.push(b.name);return a});v(c.id?"editPlan":"addPlan",d,function(a){b(c.id?IX.inherit(d,{storages:f}):a),y()})}}}var e=0;if(R&&a.msg&&A(a.msg),!c.id&&0===a.storages.length)return A("请添加存储服务器后再添加录像计划！");if(!c.id&&!R){if(0===a.zones.length)return A("请添加摄像机后再添加录像计划！");if(IX.iterate(a.zones,function(a){0===a.cameras.length&&e++}),a.zones.length===e)return A("请添加摄像机后再添加录像计划！")}if(!c.id&&R&&0===a.monitors.length)return A("请添加监视器后再添加录像计划！");if(W=null,IX.iterate(a.zones,function(a){""===a.name&&(a.name="未分区摄像机")}),U=new m(c,a),x({clz:"store-edit",title:T?c.id?"编辑录像计划":"新增录像计划":"查看录像计划",content:N.renderData("",U.getTplData()),listen:{ok:d}}),R&&(jQuery(".title_1").get(0).innerHTML="控制中心"),!T){var f=jQuery(".content");f.find("input").each(function(){this.disabled=!0}),f.find("button").attr("data-toggle",""),f.find(".pic-").hide(),f.find(".delete-day").hide(),jQuery(".btn.okbtn").hide()}})}function q(a,b){v("getPlan",{id:a?a.id:-1},function(a){var c=jQuery(".nv-tree .select").attr("data-key")||S.id;p(c,b,a)})}function r(a){var b=a.days;return a?IX.inherit(a,{days:"all"==b?"全周":IX.map(b,function(a){return TCM.Const.Days[a]||""}).join(),ssNames:Array.isArray(a.storages)?a.storages.join():""}):IX.inherit(a,{days:"",ssNames:""})}function s(){var a=TCM.LineInfo.getSites().getAll(),b=IX.loop(a,[],function(a,b){return 0!==b.type&&4!==b.type&&5!==b.type&&6!==b.type&&a.push({name:b.name,key:b.id,nodes:[]}),a}),c=IX.inherit({nodes:[{name:TCM.LineInfo.getName(),nodes:b}]},{htmlFn:function(a){return'<span class="nodeName">'+a.name+"</span>"},click:function(a,b){var c=a.keys;T=c!=S.id?!1:!0,u({siteId:c},T)}});return new TCM.Lib.Tree(c).getHTML()}function t(){var a=jQuery("#show-plan").height();jQuery("#Tree").css("height",a+"px"),jQuery(".nv-tree").css("height",a-50+"px")}function u(a,b){v("getPlans",a,function(a){var c=IX.map(a,function(a){return Z.register(a.id,a),r(a)}),d=jQuery("#show-plan").find(".store-plans");b?d.get(0).innerHTML=Y.renderData("",{plans:IX.map(c,function(a){return a.hasClz="hasHover",a}),clz:"add"}):d.get(0).innerHTML=Y.renderData("",{plans:c,clz:"notOCC"})})}var v=TCM.Global.storeCaller,w=IXW.Actions.configActions,x=NV.Dialog.show,y=NV.Dialog.hide,z=NV.Dialog.confirm,A=NV.Dialog.alert,B=NV.Lib.getComboHTML,C=function(){for(var a=0,b=[],c=0;9>c;c++){var d=10>a?"0"+a+":00":a+":00";b.push({id:d,name:d}),a+=3}return b}(),D=a(C.slice(0,C.length-1)),E=a(C.slice(1,C.length)),F=[{id:"all",name:"全周"}].concat(IX.map(TCM.Const.Days,function(a,b){return{id:b,name:a}})),G=a(IX.map([7,15,30],function(a){return{id:a,name:a+"天"}})),H=new IX.ITemplate({tpl:['<div class="leaf item">','<a class="nv-checkbox {chkClz}" data-type="{type}" data-href="${action}" data-key="{id}">','<span class="ixpic-"></span><span class="text" title="{name}">{name}</span></a>',"</div>",""]}),I=new IX.ITemplate({tpl:['<tpl id="types">','<div class="node {clz}">','<tpl id="items">',H.getTpl(),"</tpl>","</div>","</tpl>",""]}),J=new IX.ITemplate({tpl:['<div class="leaf {clz}">','<a class="nv-checkbox {chkClz}" data-href="$zone.check" data-key="{key}">','<span class="ixpic-"></span><span class="text">{name}</span></a>','<a class="nv-collapse {expClz}" data-href="$cameraTree.expand">','<span class="pic-"></span></a>',"</div>",""]}),K=new IX.ITemplate({tpl:['<tpl id="zones">','<div class="zone-cameras">',J.renderData("",{clz:"zone",key:""}),'<div class="tree-node1 type-cameras">','<tpl id="types">','<div class="leaf type">','<a class="nv-checkbox {chkClz}" data-href="${action}" data-type="{type}">','<span class="ixpic-"></span><span class="text">{name}</span></a>','<a class="nv-collapse {expClz}" data-href="$camera.expand">','<span class="pic-"></span></a>',"</div>",'<div class="tree-node2 one-cameras {clz}">','<tpl id="items">',H.getTpl(),"</tpl>","</div>","</tpl>","</div>","</div>","</tpl>",""]}),L=(new IX.ITemplate({tpl:['<div class="node type-cameras">',H.renderData("",{clz:"type",key:"type"}),'<tpl id="items">',H.renderData("",{clz:"item",key:"{id}"}),"</tpl>","</div>",""]}),TCM.Const.DeviceTypes),M=["枪机","球机","半球机"],N=new IX.ITemplate({tpl:['<div class="dialogHead">','<span class="title_1"><span class="label">单位</span><input disabled value="{siteName}"></span>','<span class="title_1"><span class="label">名称</span><input id="plan_name" value="{plan_name}"></span>',"</div>",'<a class="camera-move" data-href="$cameraPanel.hide"></a>','<div class="plan-content">','<div class="lt">','<h3><span class="label">录像时间计划表</span></h3>',"<ul>",'<li class="days-choose"><span class="label">日期计划</span>','<a id="daysName" class="daysCombo" data-href="$store.popDays">','<tpl id="dayitems">','<div id="day{id}" class="day {clz}" data-key="{id}">','<span class="text">{name}</span><span class="delete-day"></span></div>',"</tpl>",'<span class="pic-"></span>',"</a>","</li>",'<li class="circle"><span class="label">保存周期</span>{circleCombo}</li>',"<li>",'<span class="label">录像时间</span>','<span class="time-rt">','<span class="time">{fromCombo}</span>','<span class="separator">--</span>','<span class="time">{toCombo}</span>',"</span>","</li>","</ul>",'<h3><span class="label">当前单位的存储服务器</span></h3>','<div id="storages">','<tpl id="ss">','<a class="nv-checkbox {clz}" data-href="$store.checkToggle" data-key="{id}">','<span class="ixpic-"></span><span title="{name}">{name}</span></a>',"</tpl>","</div>","</div>{showDevices}",'<div id="caseCameraPanel"><h3><span class="label">未分配录像的摄像机</span></h3></div>',"</div>",""]
}),O=new IX.ITemplate({tpl:['<div class="useCamera">','<h3><span class="label">已在录像的摄像机</span></h3>','<div class="showCamera">{showCamera}</div>','<a class="more" data-href="$store.addCamera">','<span class="add-camera">新增需要录像的摄像机</span>','<span class="add"></span>',"</a>","</div>",""]}),P=new IX.ITemplate({tpl:['<h3><span class="label">已在录像的监视器</span></h3>','<div class="showMonitor">{showMonitor}</div>',""]}),Q=new IX.ITemplate({tpl:['<div class="node">','<a class="nv-checkbox {clz}" data-href="$store.checkAll" data-key="all">','<span class="ixpic-"></span><span class="text">{name}</span></a>',"</div>",'<tpl id="items">','<div class="leaf ">','<a class="nv-checkbox {clz}" data-href="$store.checkOne" data-key="{id}">','<span class="ixpic-"></span><span class="text">{name}</span></a>',"</div>","</tpl>",""]}),R=null,S=null,T=null,U=null,V=null,W=null;w([["store.pick",function(a,b){var c=a.key,d=b.innerHTML,e=$XH.ancestor(b,"dropdown");if(e){var f=$XD.first(e,"input");f.value=c;var g=$XH.first($XH.first(e,"dropdown-toggle"),"name");g.innerHTML=d;var h=f.id.split("_")[1];U.setProperty(h,c)}}],["store.checkToggle",function(a,b){if(T){var c=!$XH.hasClass(b,"selected");$XH[c?"addClass":"removeClass"](b,"selected"),jQuery(b).siblings().each(function(){$XH.hasClass(this,"selected")&&($XH.removeClass(this,"selected"),U.setArr("storages",$XD.attr(this,"data-key"),!1))}),U.setArr("storages",a.key,c)}}],["store.popDays",function(a,b,c){if(T){var d=c.target;return $XH.ancestor(d,"day")&&$XH.hasClass(d,"delete-day")?U.setDays($XD.dataAttr(d.parentNode,"key"),!1):void V.trigger($X("daysName"))}}],["store.checkAll",function(a,b){if(T){var c=!$XH.hasClass(b,"selected");$XH[c?"addClass":"removeClass"](b,"selected"),U.setDays("all",c)}}],["store.checkOne",function(a,b){if(T){var c=!$XH.hasClass(b,"selected");$XH[c?"addClass":"removeClass"](b,"selected"),U.setDays(a.key,c)}}],["store.addCamera",function(a,b){T&&(W||(W=new l(U)),W.show())}],["cameraPanel.hide",function(a,b){T&&W.hide()}],["cameras.move",function(a,b){if(T){var c=!$XH.hasClass(b,"selected");return $XH[c?"addClass":"removeClass"](b,"selected"),R?U.setArr("monitors",a.key,c):void($XH.hasClass(b.parentNode,"type")?($XH.removeClass(b,"part"),o(b,c)):n(a.key,b,c))}}],["zone.check",function(a,b){var c=!$XH.hasClass(b,"selected");$XH.removeClass(b,"part"),$XH.toggleClass(b,"selected"),jQuery($XH.ancestor(b,"zone")).next().find(".nv-checkbox")[c?"addClass":"removeClass"]("selected"),jQuery($XH.ancestor(b,"zone")).next().find(".type .nv-checkbox").each(function(){o(this,c)})}]]);var X=new IX.ITemplate({tpl:['<div id="Tree" class="{clz}"><div id="treeName">{treeName}</div>{tree}</div>','<div id="show-plan" class="nv-box">','<div class="nv-title">录像计划</div>','<ul class="store-plans"></ul>',"</div>",""]}),Y=new IX.ITemplate({tpl:['<tpl id="plans">','<li class="{hasClz}"><a data-href="$store.edit" data-key="{id}">','<div class="pic-">','<div><span class="label">存储服务器：</span><span>{ssNames}</span></div>','<div><span class="label">保存周期：</span><span>{circle}天</span></div>','<div><span class="label">日期计划：</span><span>{days}</span></div>','<div><span class="label">录像时间：</span><span>从{from}至{to}</span></div>',"</div>",'<div class="name">{name}</div>','</a><a class="pic-del" data-href="$store.delete" data-key="{id}">',"</a></li>","</tpl>",'<li class="{clz}"><a data-href="$store.add">','<div class="pic-"></div>','<div class="name">添加录像计划</div>',"</a></li>",""]}),Z=new IX.IListManager;w([["store.add",function(a,b){q(null,function(a){Z.register(a.id,a),a.hasClz="hasHover";var c=Y.renderData("plans",r(a));jQuery(c).insertBefore(b.parentNode)})}],["store.edit",function(a,b){var c=a.key,d=Z.get(c);d&&q(d,function(a){Z.register(d.id,a),d.hasClz="hasHover";var c=Y.renderData("plans",r(a));b.parentNode.innerHTML=c.substring('<li class="hasHover">'.length,c.length-"</li>".length)})}],["store.delete",function(a,b){if(T){var c=a.key,d=Z.get(c);d&&z("删除录像计划","请确认是否删除此录像计划?",function(a){v("deletePlan",{ids:[d.id]},function(){Z.remove(c);var a=b.parentNode;a.parentNode.removeChild(a),y()})})}}]]),IX.ns("TCM.Store"),TCM.Store.init=function(a,b,c){if(R=1==TCM.Env.getSession().getCurrentSiteType(),S=TCM.Env.getSession().getCurrentSite(),Z.clear(),R){var d=s();$X("body").innerHTML=X.renderData("",{treeName:"线路录像列表",clz:"",tree:d}),jQuery(".nv-tree>ul ul").hide(),jQuery("#Tree span.nodeName").each(function(){this.innerHTML==S.name&&this.click()}),jQuery(".nv-tree span:first").click(),t(),$Xw.bind({resize:t})}else T=!0,$X("body").innerHTML=X.renderData("",{treeName:"",clz:"notOCC",tree:""}),u({},T);c()}}(),function(){function a(){n.stop(),n.start()}function b(){var a=IX.isOper||IX.isChrome||IX.isSafari||IX.isFirefox,b=document.location.href.indexOf("#unSupport")>-1?!1:!(a&&IX.isBelowMSIE9),c=[{name:"IE10",href:"http://windows.microsoft.com/zh-cn/internet-explorer/ie-10-worldwide-languages",icon:"ie"},{name:"IE11",href:"http://windows.microsoft.com/zh-cn/internet-explorer/ie-11-worldwide-languages",icon:"ie"},{name:"Firefox",href:"http://firefox.com.cn/",icon:"firefox"},{name:"Safari浏览器",href:"http://www.apple.com.cn/safari/",icon:"safari"},{name:"chrome浏览器",href:"http://rj.baidu.com/soft/detail/14744.html",icon:"chrome"},{name:"360极速浏览器",href:"http://chrome.360.cn/",icon:"chrome360"}];return b||(document.body.className="minor browser_unsupport",document.body.innerHTML=p.renderData("",{bs:c})),b}function c(a){function b(){var a=TCM.LineInfo.getSites();j=a&&a.get(f);var b=!1;IX.iterate(a.getAll(),function(a){a.type==l.OCC&&(b=!0)}),k=h&&!b||j&&j.type==l.OCC?["lineInfo"]:[]}var c=$XP(a,"name",""),d=$XP(a,"account",""),e=$XP(a,"id",null),f=$XP(a,"siteId",null),g=$XP(a,"type",1),h=g==m.Super,j=null,k=[];return b(),q.setItem("tcmSessionKey",f+"-"+e),{hasAuth:function(){return null!==e},getUserName:function(){return c},getAccount:function(){return d},getUserId:function(){return e},getCurrentSiteId:function(){return f},getCurrentSite:function(){return j},setCurrentSiteId:function(a){f=a,b()},getSessionKey:function(){return f+"-"+e},setUserName:function(a){c=a,jQuery(".profile").children(".name").html(c)},getCurrentSiteType:function(){return j?j.type:""},isSuper:function(){return h},checkIfModuleEnabled:function(a){return i(a,k)}}}function d(a){function b(a){var b=a[0];return{name:b,text:a[1],clz:"",href:a[2]||j.createPath(b)}}function c(a){var c=a[0],d=a.length>2?a[2]:[];return{name:c,text:a[1],clz:d.length>0?"":"nosub",href:j.createPath(d.length>0?d[0][0]:c),subnav:IX.map(d,b)}}function d(a,b){var c=a.split("-"),d=b?$XH.addClass:$XH.removeClass;2==c.length&&d($X("nav-"+c[0]),"active"),d($X("nav-"+a),"active")}function e(a){var b=$X("nav-"+a);a!=g&&b&&(d(g,!1),g=a,d(a,!0))}function f(){jQuery(".main li").hover(function(){$XH.addClass(this,"hover")},function(a){var b=this,c=$XH.ancestor(a.toElement,"ul");c=c?c.parentNode:null,$XH.hasClass(c,"hover")||$XH.removeClass(b,"hover")})}var g=a||u;return{getRenderData:function(){return IX.map(r.isSuper()?t:s,c)},enableHover:f,focus:e}}function e(){r=new c,TCM.LineInfo.destroy(),n.stop(),IXW.Pages.load("entry")}function f(b){TCM.LineInfo.init(b.lineInfo),r=new c(b);var d=TCM.LineInfo.getSites().get(b.siteId)?TCM.LineInfo.getSites().get(b.siteId).name:"";document.body.innerHTML=o.renderData("",{nav:v.getRenderData(),username:b.name,sitename:d}),v.enableHover(),a()}function g(a){TCM.Global.commonCaller("session",{},function(b){return b&&b.id?(f(b),void a()):j.load("entry")})}function h(){setInterval(function(){var a=q.getItem("tcmSessionKey");if(a!=r.getSessionKey())return"null-null"==a?NV.Dialog.confirm4login("提示","当前用户已在其他窗口退出，请重新登录！",{left:[],right:[{name:"ok",text:"确定"}]},function(){g(function(){j.reload()})}):void NV.Dialog.confirm4login("提示","已存在登录用户，请刷新页面！",{left:[],right:[{name:"ok",text:"确定"}]},function(){g(function(){j.reload()})})},3e3)}var i=IX.Array.isFound,j=IXW.Pages,k=IXW.Actions,l=TCM.Const.SiteTypes,m=TCM.Const.UserTypes,n=new TCM.Util.PeriodicChecker("",function(a,b){TCM.Global.commonCaller("isKicked","",function(c){return c&&1===c.status?NV.Dialog.confirm4login("提示","有新管理员登录系统，请您退出！",{left:[],right:[{name:"ok",text:"确定"}]},function(){e()}):(a=!0,void b())})},1),o=new IX.ITemplate({tpl:['<nav class="navbar navbar-inverse navbar-fixed-top">','<div class="container-fluid">','<div class="navbar-header">','<a href="#"><span class="badges"></span><span class="navbar-brand">CCTV配置管理</span></a>',"</div>",'<ul class="nav navbar-nav main">','<tpl id="nav">','<li id="nav-{name}" class="{clz}">','<a data-href="{href}">','<span class="nav-{name}"></span><span>{text}</span>',"</a>",'<ul class="sub">','<tpl id="subnav">','<li id="nav-{name}" class="{clz}">','<a data-href="{href}">{text}</a>',"</li>","</tpl>","</ul>","</li>","</tpl>","</ul>",'<ul class="nav navbar-nav navbar-right">','<li class="nowSite"><span class="name">{sitename}</span></li>','<li class="profile"><span class="sp"></span><span class="pic-avatar"></span><span class="name">{username}</span></li>','<li class="logout"><a data-href="$logout"><span class="sp"></span><span>退出</span></a></li>',"</ul>","</div>","</nav>",'<div class="bg"><div class="fix-bottom"></div></div>','<div id="topbar" class="hide"></div>','<div id="body"></div>',""]
}),p=new IX.ITemplate({tpl:['<div class="bu">','<div class="hdrp"><i class="pic logo"></i></div>','<div class="content">','<div class="t">',"<p>当前使用的浏览器版本过低，无法正常使用infobox服务，推荐您下载安装以下浏览器中的任一款，然后再用新浏览器访问（www.CCTVxxx.com），给您带来不便，非常抱歉。</p>","</div>",'<div class="label">',"<ul>","<tpl id='bs'>","<li>","<a class ='i {icon}'></a>","<span>{name}</span>",'<a class = \'href\' target="_blank" href="{href}">{href}</a>',"</li>","</tpl>","</ul>","</div>","</div>","</div>",""]}),q=function(){var a=window.localStorage;return{getItem:function(b){return a.getItem(b)||null},setItem:function(b,c){a.setItem(b,c)},clear:function(){a.clear()}}}(),r=new c,s=[["sys","系统管理",[["sys-line","线路和车站管理"],["sys-role","角色管理"],["sys-level","用户优先级定义"],["sys-user","用户管理"],["sys-config","系统设置"]]],["device","设备管理",[["device-list","设备列表"],["device-zone","摄像机分区"],["device-video","电视墙"]]],["store","存储管理"]],t=[["sys","系统管理",[["sys-line","线路和车站管理"],["sys-role","角色管理"],["sys-level","用户优先级定义"],["sys-user","用户管理"]]]],u="sys-line",v=new d,w=IX.map([{type:"ErrPage",name:"401",needAuth:!1},{type:"ErrPage",name:"404",needAuth:!1},{name:"sys-line",isDefault:!0},{name:"sys-role"},{name:"sys-level"},{name:"sys-user"},{name:"sys-config"},{name:"device-list",path:"device/{type}/list"},{name:"device-zone",path:"device/{id}/{type}/zone"},{name:"device-zoneMap",path:"device/{id}/map"},{name:"device-video",path:"device/{type}/video"},{name:"store"},{name:"entry",bodyClz:"entry",needAuth:!1}],function(a){var b=a.name,c=b.split("-"),d=c[0],e=a.type||d.capitalize();return IX.inherit({initiator:"TCM."+e+".init",path:c.join("/"),nav:"service",navItem:b,needAuth:!0},a)});k.configActions([["logout",function(){function a(){TCM.Global.entryCaller("logout",{},function(){e()})}NV.Dialog.confirm("提示","确认是否退出?",a)}]]),IX.ns("TCM.Env"),TCM.Env.init=function(){j.listenOnClick(document.body),j.configPages(w,function(a,b){return!$XP(b,"needAuth",!0)||r.hasAuth()}),IXW.Navs.register("service",function(a){v.focus(a.navItem||"")}),g(function(){j.start()}),h(),$Xw.bind({keydown:function(a){if(8==a.keyCode&&"none"!=jQuery("#nv-dialog").css("display")){if("INPUT"==a.target.nodeName)return;IX.Util.Event.stop(a)}}})},TCM.Env.isMe=function(a){return a===r.getUserId()},TCM.Env.reloadSession=function(){g(function(){j.reload()})},TCM.Env.clearSession=e,TCM.Env.hasSession=function(){return r.hasAuth()},TCM.Env.resetSession=function(a){f(a)},TCM.Env.getSession=function(){return r},TCM.Env.canUpdateLineInfo=function(){return r.checkIfModuleEnabled("lineInfo")},TCM.Env.isKicked=function(){n.stop()};var x=!1;TCM.init=function(){x||(x=!0,b(),TCM.Env.init())}}();